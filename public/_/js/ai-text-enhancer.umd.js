!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).AITextEnhancer=n()}(this,(function(){"use strict";const e={en:{modalTrigger:"Enhance with AI (Beta)",modalTitle:"Enhance your text",tools:{improve:"Improve",summarize:"Summarize",expand:"Expand",paraphrase:"Paraphrase","more-formal":"More Formal","more-casual":"More Casual","chat-question":"Question","chat-response":"Response","chat-error":"Error"},actions:{copy:"Copy",use:"Use",edit:"Edit",retry:"Retry",insert:"Insert",replace:"Replace",generate:"Generate"},preview:{placeholder:"Enhanced text will appear here"},chat:{placeholder:"Ask a question about the product description...",question:"Question",contentPrompt:"Could you improve the text I have in the editor?",contextPrompt:"Please create a professional description based on the following context.",emptyPrompt:"What type of content would you like me to help you create?"},errors:{apiKey:"Error: API key not configured. Please provide a valid API key.",initialization:"Error initializing component:",request:"Error processing request:"}},es:{modalTrigger:"Mejorar con IA (Beta)",modalTitle:"Mejora tu texto",tools:{improve:"Mejorar",summarize:"Resumir",expand:"Ampliar",paraphrase:"Parafrasear","more-formal":"Más formal","more-casual":"Más casual","chat-question":"Pregunta","chat-response":"Respuesta","chat-error":"Error"},actions:{copy:"Copiar",use:"Usar",edit:"Editar",retry:"Reintentar",insert:"Insertar",replace:"Reemplazar",generate:"Generar"},preview:{placeholder:"El texto mejorado aparecerá aquí"},chat:{placeholder:"Haz una pregunta sobre la descripción del producto...",question:"Pregunta",contentPrompt:"¿Podrías mejorar el texto que tengo en el editor?",contextPrompt:"Por favor, crea una descripción profesional basada en el siguiente contexto.",emptyPrompt:"¿Qué tipo de contenido te gustaría que te ayude a crear?"},errors:{apiKey:"Error: API key no configurada. Por favor proporciona una API key válida.",initialization:"Error inicializando componente:",request:"Error procesando solicitud:"}},fr:{modalTrigger:"Améliorer avec IA (Beta)",modalTitle:"Améliorez votre texte",tools:{improve:"Améliorer",summarize:"Résumer",expand:"Développer",paraphrase:"Paraphraser","more-formal":"Plus Formel","more-casual":"Plus Décontracté","chat-question":"Question","chat-response":"Réponse","chat-error":"Erreur"},actions:{retry:"Réessayer",insert:"Insérer",replace:"Remplacer",generate:"Générer",copy:"Copier",use:"Utiliser",edit:"Éditer"},preview:{placeholder:"Le texte amélioré apparaîtra ici"},chat:{placeholder:"Posez une question sur la description du produit...",question:"Question",contentPrompt:"Pourriez-vous améliorer le texte que j'ai dans l'éditeur ?",contextPrompt:"Veuillez créer une description professionnelle basée sur le contexte suivant.",emptyPrompt:"Quel type de contenu souhaitez-vous que je vous aide à créer ?"},errors:{apiKey:"Erreur : Clé API non configurée. Veuillez fournir une clé API valide.",initialization:"Erreur d'initialisation du composant :",request:"Erreur lors du traitement de la demande :"}},de:{modalTrigger:"Beschreibung Verbessern mit KI (Beta)",modalTitle:"Verbessern Sie Ihre Beschreibung",tools:{improve:"Verbessern",summarize:"Zusammenfassen",expand:"Erweitern",paraphrase:"Umformulieren","more-formal":"Formaler","more-casual":"Lockerer","chat-question":"Frage","chat-response":"Antwort","chat-error":"Fehler"},actions:{retry:"Wiederholen",insert:"Einfügen",replace:"Ersetzen",generate:"Generieren",copy:"Kopieren",use:"Verwenden",edit:"Bearbeiten"},preview:{placeholder:"Verbesserter Text erscheint hier"},chat:{placeholder:"Stellen Sie eine Frage zur Produktbeschreibung...",question:"Frage",contentPrompt:"Könnten Sie den Text in meinem Editor verbessern?",contextPrompt:"Bitte erstellen Sie eine professionelle Beschreibung basierend auf dem folgenden Kontext.",emptyPrompt:"Welche Art von Inhalt möchten Sie, dass ich Ihnen erstellen helfe?"},errors:{apiKey:"Fehler: API-Schlüssel nicht konfiguriert. Bitte geben Sie einen gültigen API-Schlüssel an.",initialization:"Fehler bei der Initialisierung der Komponente:",request:"Fehler bei der Verarbeitung der Anfrage:"}},pt:{modalTrigger:"Melhorar com IA (Beta)",modalTitle:"Melhore sua texto",tools:{improve:"Melhorar",summarize:"Resumir",expand:"Expandir",paraphrase:"Parafrasear","more-formal":"Mais Formal","more-casual":"Mais Casual","chat-question":"Pergunta","chat-response":"Resposta","chat-error":"Erro"},actions:{retry:"Tentar Novamente",insert:"Inserir",replace:"Substituir",generate:"Gerar",copy:"Copiar",use:"Usar",edit:"Editar"},preview:{placeholder:"O texto melhorado aparecerá aqui"},chat:{placeholder:"Faça uma pergunta sobre a descrição do produto...",question:"Pergunta",contentPrompt:"Você poderia melhorar o texto que tenho no editor?",contextPrompt:"Por favor, crie uma descrição profissional com base no seguinte contexto.",emptyPrompt:"Que tipo de conteúdo você gostaria que eu ajudasse a criar?"},errors:{apiKey:"Erro: Chave API não configurada. Por favor, forneça uma chave API válida.",initialization:"Erro ao inicializar componente:",request:"Erro ao processar solicitação:"}},it:{modalTrigger:"Migliorare con IA (Beta)",modalTitle:"Migliorare il tuo testo",tools:{improve:"Migliorare",summarize:"Sommario",expand:"Espandere",paraphrase:"Parafrasare","more-formal":"Più Formale","more-casual":"Più Casual","chat-question":"Domanda","chat-response":"Risposta","chat-error":"Errore"},actions:{retry:"Riprova",insert:"Inserire",replace:"Sostituire",generate:"Generare",copy:"Copiare",use:"Usare",edit:"Modificare"},preview:{placeholder:"Il testo migliorato apparirà qui"},chat:{placeholder:"Fai una domanda sulla descrizione del prodotto...",question:"Domanda",contentPrompt:"Potresti migliorare il testo che ho nell'editor?",contextPrompt:"Per favore, crea una descrizione professionale basata sul seguente contesto.",emptyPrompt:"Che tipo di contenuto vorresti che ti aiutassi a creare?"},errors:{apiKey:"Errore: Chiave API non configurata. Fornisci una chiave API valida.",initialization:"Errore inizializzazione componente:",request:"Errore elaborazione richiesta:"}}},n=e=>{const n={improve:'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/>\n          <path d="m14 7 3 3"/>\n        </svg>\n      ',summarize:'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>\n          <path d="M9 10h6"/>\n        </svg>\n      ',expand:'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>\n          <path d="M9 10h6"/><path d="M12 7v6"/>\n        </svg>\n      ',paraphrase:'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M21 6H3"/><path d="M7 12H3"/><path d="M7 18H3"/>\n          <path d="M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14"/>\n          <path d="M11 10v4h4"/>\n        </svg>\n      ',"more-formal":'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <rect width="20" height="14" x="2" y="7" rx="2" ry="2"/>\n          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>\n        </svg>\n      ',"more-casual":'\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <circle cx="12" cy="12" r="10"/>\n          <path d="M8 14s1.5 2 4 2 4-2 4-2"/>\n          <line x1="9" x2="9.01" y1="9" y2="9"/>\n          <line x1="15" x2="15.01" y1="9" y2="9"/>\n        </svg>\n      ',"chat-question":'\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n      </svg>\n    ',"chat-response":'\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="M3 15a2 2 0 0 0 2 2h14l4 4V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z"/>\n      </svg>\n    ',"chat-error":'\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <circle cx="12" cy="12" r="10"/>\n        <line x1="12" y1="8" x2="12" y2="12"/>\n        <line x1="12" y1="16" x2="12.01" y2="16"/>\n      </svg>\n    '};return n[e]||n.improve},t="\n  :host {\n    --ai-primary: #3b82f6;\n    --ai-primary-hover: #2563eb;\n    --ai-secondary: #e5e7eb;\n    --ai-secondary-hover: #d1d5db;\n    --ai-text: #1f2937;\n    --ai-text-light: #6b7280;\n    --ai-border: #e5e7eb;\n    --ai-success: #10b981;\n    --ai-warning: #f59e0b;\n    --ai-error: #dc2626;\n    --ai-background: #ffffff;\n    --ai-background-light: #f9fafb;\n    \n    --ai-shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n    --ai-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);\n    --ai-shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n    \n    --ai-radius-sm: 0.375rem;\n    --ai-radius: 0.5rem;\n    --ai-radius-md: 0.75rem;\n    --ai-radius-lg: 1rem;\n    \n    --ai-font-sans: system-ui, -apple-system, sans-serif;\n    --ai-z-modal: 99999;\n    --ai-z-content: 100000;\n\n    /* Gradient colors */\n    --ai-gradient-start: #da22ff;\n    --ai-gradient-middle: #9733ee;\n    --ai-gradient-end: #da22ff;\n  }\n",o="\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  @keyframes blink {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0; }\n  }\n\n  @keyframes glow {\n    0% { background-position: 0 0; }\n    50% { background-position: 200% 0; }\n    100% { background-position: 0 0; }\n  }\n\n  @keyframes shake {\n    0%, 100% { transform: rotate(0deg); }\n    25% { transform: rotate(5deg); }\n    50% { transform: rotate(-5deg); }\n    75% { transform: rotate(5deg); }\n  }\n\n  @keyframes pulse {\n    0% { transform: scale(1); }\n    50% { transform: scale(1.05); }\n    100% { transform: scale(1); }\n  }\n",r="\n  .preview {\n    flex: 1;\n    overflow-y: auto;\n    background: var(--ai-background);\n    border-radius: var(--ai-radius);\n  }\n\n  .response-tool {\n    font-weight: 500;\n    color: var(--ai-text);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n  }\n\n  .response-timestamp {\n    color: var(--ai-text-light);\n    font-size: 0.875rem;\n  }\n\n  .response-action.primary {\n    background: var(--ai-primary);\n    color: white;\n  }\n\n  .response-action.primary:hover {\n    background: var(--ai-primary-hover);\n  }\n";class i extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.responses=[],this.markdownHandler=null}static get observedAttributes(){return["language"]}get language(){const e=this.getAttribute("language");return console.log("[ResponseHistory] Getting language:",e),e||"en"}connectedCallback(){console.log("[ResponseHistory] Connected, language:",this.language),console.log("[ResponseHistory] Has language attribute:",this.hasAttribute("language")),console.log("[ResponseHistory] All attributes:",this.getAttributeNames()),this.translations=e[this.language]||e.en,console.log("[ResponseHistory] Initial translations:",this.translations),this.render(),this.setupEventListeners()}attributeChangedCallback(n,t,o){console.log("[ResponseHistory] Attribute changed:",n,"from",t,"to",o),"language"===n&&t!==o&&(console.log("[ResponseHistory] Updating translations for new language:",o),this.translations=e[o]||e.en,console.log("[ResponseHistory] New translations:",this.translations),this.render())}createResponseEntry(e){var t,o,r,i,a,s,l,d,c;const p=document.createElement("div");p.className="response-entry",p.dataset.id=e.id,p.dataset.action=e.action;const h=["info","error","chat-error"].includes(e.action),m="chat-question"===e.action;if(h)return p.innerHTML=`\n      <div class="response-content-wrapper">\n        <div class="response-content">\n          ${this.markdownHandler?this.markdownHandler.convert(e.content):e.content}\n        </div>\n      </div>\n    `,p;if(m){const t=void 0!==e.image&&null!==e.image;return p.innerHTML=t?`\n        <div class="response-content-wrapper">\n          <div class="response-header mini">\n            <div class="response-tool">\n              ${n(e.action)}\n              <span>Pregunta:</span>\n            </div>\n            <div class="response-timestamp">${this.formatTimestamp(e.timestamp)}</div>\n          </div>\n          <div class="question-container">\n            <div class="question-content">\n              ${e.content.replace(/^\*\*Pregunta:\*\*\s*/i,"")}\n            </div>\n            <div class="question-image mini">\n              <img src="${URL.createObjectURL(e.image)}" alt="Imagen adjunta">\n            </div>\n          </div>\n          <div class="response-footer mini">\n            <button class="response-action edit-button mini" data-response-id="${e.id}">\n              <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n          </div>\n        </div>\n      `:`\n        <div class="response-content-wrapper">\n          <div class="response-header mini">\n            <div class="response-tool">\n              ${n(e.action)}\n              <span>Pregunta:</span>\n            </div>\n            <div class="response-timestamp">${this.formatTimestamp(e.timestamp)}</div>\n          </div>\n          <div class="response-content">\n            ${e.content.replace(/^\*\*Pregunta:\*\*\s*/i,"")}\n          </div>\n          <div class="response-footer mini">\n            <button class="response-action edit-button mini" data-response-id="${e.id}">\n              <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n          </div>\n        </div>\n      `,p}const u=document.createElement("div");u.className="response-content-wrapper";const g=""===e.content||e.content.length<5,v=g?"response-content typing-animation":"response-content";let f;f="image-upload"===e.action?e.content:g?"chat-response"===e.action?'<div class="typing-indicator">Escribiendo respuesta...</div>':["improve","summarize","expand","paraphrase","more-formal","more-casual"].includes(e.action)?'<div class="typing-indicator">Pensando...</div>':"":this.markdownHandler?this.markdownHandler.convert(e.content):e.content;const y=["error","info","chat-error"].includes(e.action);let b="";m||y||(b=`\n        <button class="tool-button" data-action="improve" data-response-id="${e.id}">\n          ${n("improve")}\n          ${(null==(o=null==(t=this.translations)?void 0:t.tools)?void 0:o.improve)||"Improve"}\n        </button>\n        <button class="tool-button" data-action="summarize" data-response-id="${e.id}">\n          ${n("summarize")}\n          ${(null==(i=null==(r=this.translations)?void 0:r.tools)?void 0:i.summarize)||"Summarize"}\n        </button>\n        <button class="tool-button" data-action="expand" data-response-id="${e.id}">\n          ${n("expand")}\n          ${(null==(s=null==(a=this.translations)?void 0:a.tools)?void 0:s.expand)||"Expand"}\n        </button>\n        <button class="tool-button" data-action="paraphrase" data-response-id="${e.id}">\n          ${n("paraphrase")}\n          ${(null==(d=null==(l=this.translations)?void 0:l.tools)?void 0:d.paraphrase)||"Paraphrase"}\n        </button>\n      `);const x=y||m?"":`\n    <div class="response-footer">\n      <div class="response-tools">\n        ${b}\n      </div>\n      <div class="response-actions">\n        <button class="response-action copy-button" data-response-id="${e.id}">\n          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">\n            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>\n            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>\n          </svg>\n        </button>\n        <button class="response-action use-button" data-response-id="${e.id}">\n          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">\n            <polyline points="20 6 9 17 4 12"/>\n          </svg>\n        </button>\n        <button class="response-action retry-button" data-response-id="${e.id}" data-action="${e.action}">\n          <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">\n            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>\n          </svg>\n        </button>\n      </div>\n    </div>\n  `;if(u.innerHTML=`\n    <div class="response-header">\n      <div class="response-tool">\n        ${n(e.action)}\n        <span>${(null==(c=this.translations)?void 0:c.tools[e.action])||e.action}</span>\n      </div>\n      <div class="response-timestamp">${this.formatTimestamp(e.timestamp)}</div>\n    </div>\n    <div class="${v}">\n      ${f}\n    </div>\n    ${x}\n  `,!this.shadowRoot.querySelector("#mini-elements-style")){const e=document.createElement("style");e.id="mini-elements-style",e.textContent='\n      /* Estilos para elementos miniatura */\n      .mini {\n        margin: 0 !important;\n        padding: 0 !important;\n      }\n      \n      .response-header.mini {\n        margin-bottom: 0.25rem !important;\n      }\n      \n      .response-footer.mini {\n        padding-top: 0.25rem !important;\n        display: flex;\n        justify-content: flex-end;\n      }\n      \n      .question-image.mini {\n        width: 60px !important;\n        height: 60px !important;\n      }\n      \n      .question-image.mini img {\n        width: 60px !important;\n        height: 60px !important;\n      }\n      \n      .response-action.mini {\n        padding: 0.25rem !important;\n      }\n      \n      /* Estilos específicos para mensajes de información */\n      .response-entry[data-action="info"],\n      .response-entry[data-action="error"],\n      .response-entry[data-action="chat-error"] {\n        padding: 0.5rem 0.75rem !important;\n      }\n      \n      /* Estilos específicos para preguntas */\n      .response-entry[data-action="chat-question"] {\n        padding: 0.5rem 0.75rem !important;\n      }\n      \n      .question-container {\n        display: flex;\n        gap: 0.5rem;\n        align-items: flex-start;\n        margin: 0;\n        padding: 0;\n      }\n    ',this.shadowRoot.appendChild(e)}return p.appendChild(u),p}setupEventListeners(){this.shadowRoot.addEventListener("click",(e=>{const n=e.target.closest("button");if(!n)return;const t=n.dataset.responseId;if(!t)return;const o=this.getResponse(t);if(o)if(n.classList.contains("tool-button")){const e=n.dataset.action;console.log("[ResponseHistory] Tool button clicked:",{action:e,responseId:t}),this.dispatchEvent(new CustomEvent("toolaction",{detail:{action:e,responseId:t,content:o.content},bubbles:!0,composed:!0}))}else if(n.classList.contains("retry-button")){const e=n.dataset.action;this.dispatchEvent(new CustomEvent("responseRetry",{detail:{responseId:t,action:e},bubbles:!0,composed:!0}))}else if(n.classList.contains("edit-button"))this.dispatchEvent(new CustomEvent("responseEdit",{detail:{responseId:t},bubbles:!0,composed:!0}));else if(n.classList.contains("copy-button"))this.dispatchEvent(new CustomEvent("responseCopy",{detail:{responseId:t},bubbles:!0,composed:!0}));else if(n.classList.contains("use-button"))console.log("[ResponseHistory] Use button clicked"),this.dispatchEvent(new CustomEvent("responseUse",{detail:{responseId:t},bubbles:!0,composed:!0})),setTimeout((()=>{var e;console.log("[ResponseHistory] Attempting to close modal");try{let n=this;for(;n;){if(console.log("[ResponseHistory] Checking element for modal class:",n),null==(e=n.classList)?void 0:e.contains("modal")){console.log("[ResponseHistory] Found modal element:",n),n.classList.remove("open");break}n=n.parentNode||n.getRootNode().host}}catch(n){console.error("[ResponseHistory] Error closing modal:",n)}}),100);else if(n.classList.contains("retry-button")){const e=n.dataset.action;this.dispatchEvent(new CustomEvent("responseRetry",{detail:{responseId:t,action:e},bubbles:!0,composed:!0}))}}))}getResponse(e){console.log("[ResponseHistory] Getting response for ID:",e),console.log("[ResponseHistory] Available responses:",this.responses);const n=this.responses.find((n=>n.id===parseInt(e)));return console.log("[ResponseHistory] Found response:",n),n}addResponse(e){console.log("[ResponseHistory] Adding response:",e),this.responses.push(e),this.render()}updateResponse(e,n){var t;const o=this.responses.findIndex((n=>n.id===e));if(-1===o)return;const r=this.responses[o],i=r.content;r.content="function"==typeof n?n(r.content):n;const a=""===i,s="function"==typeof n&&r.content.length>i.length&&r.content.startsWith(i),l=this.shadowRoot.querySelector(`[data-id="${e}"]`);if(!l)return void this.render();const d=l.querySelector(".response-content");if(d)if(a){console.log("[ResponseHistory] Primera actualización, configurando streaming");const e=document.createTextNode("");d.innerHTML="",d.appendChild(e),d.dataset.streamingActive="true",d.classList.add("typing-animation")}else if(s&&"true"===d.dataset.streamingActive){const e=r.content.substring(i.length);if(d.lastChild&&d.lastChild.nodeType===Node.TEXT_NODE)d.lastChild.nodeValue+=e;else{const e=document.createTextNode(r.content);d.innerHTML="",d.appendChild(e)}}else{console.log("[ResponseHistory] Streaming completo o actualización no incremental");if(r.content.length>50&&"true"===d.dataset.streamingActive){d.classList.remove("typing-animation"),d.dataset.streamingActive="false";const e=r.content,n=(null==(t=l.parentNode)?void 0:t.scrollTop)||0;if(this.markdownHandler)try{d.innerHTML=this.markdownHandler.convert(e)}catch(c){console.error("[ResponseHistory] Error applying markdown:",c),d.textContent=e}else d.textContent=e;l.parentNode&&(l.parentNode.scrollTop=n)}else s||(this.markdownHandler?d.innerHTML=this.markdownHandler.convert(r.content):d.textContent=r.content)}}getTypingPlaceholder(){return'<span class="typing">|</span>'}getResponse(e){return this.responses.find((n=>n.id===parseInt(e)))}removeResponse(e){this.responses=this.responses.filter((n=>n.id!==e)),this.render()}clear(){this.responses=[],this.render()}render(){const e=document.createElement("style");e.textContent=`\n      ${t}\n      ${o}\n      ${r}\n      \n  /* ===== CONTENEDORES PRINCIPALES ===== */\n  .response-container {\n    overflow-y: auto;\n    max-height: 100%;\n  }\n\n  .response-entry {\n    background: var(--ai-surface);\n    border-radius: var(--ai-radius);\n    border: 1px solid var(--ai-border);\n    margin-bottom: 1rem;\n    padding: 1rem;\n    /* Optimizaciones de rendimiento */\n    contain: content;\n    position: relative;\n    will-change: contents;\n    transform: translateZ(0);\n    backface-visibility: hidden;\n  }\n\n  .response-content-wrapper {\n    flex: 1;\n    min-width: 0;\n    /* Optimizar para cambios frecuentes */\n    will-change: contents;\n  }\n\n  .response-entry[data-action="error"],\n  .response-entry[data-action="info"],\n  .response-entry[data-action="chat-error"] {\n    background: var(--ai-surface-light);\n    border-left: 3px solid var(--ai-error);\n    padding-left: calc(1rem - 3px);\n  }\n\n  .response-entry[data-action="info"] {\n    border-left-color: var(--ai-info);\n  }\n\n  /* ===== ÁREA DE CONTENIDO ===== */\n  .response-content {\n    margin: 1rem 0;\n    line-height: 1.5;\n    word-break: break-word;\n    overflow-wrap: break-word;\n    position: relative;\n    min-height: 1.5em;\n  }\n\n  /* Control para streaming activo */\n  .response-content[data-streaming-active="true"] {\n    transition: none !important;\n    user-select: none;\n  }\n\n  /* Desactivar transiciones durante streaming para contenido anidado */\n  .response-content[data-streaming-active="true"] * {\n    transition: none !important;\n  }\n\n  /* Restaurar selección cuando termina el streaming */\n  .response-content:not([data-streaming-active="true"]) {\n    user-select: text;\n  }\n\n  /* Contenido para markdown */\n  .response-content p {\n    margin: 0.5em 0;\n    animation: textReveal 0.2s ease-out forwards;\n  }\n\n  .response-content ul, \n  .response-content ol {\n    margin: 0.5em 0;\n    padding-left: 1.5em;\n  }\n\n  .response-content pre {\n    background: var(--ai-surface-dark);\n    padding: 1rem;\n    border-radius: var(--ai-radius);\n    overflow-x: auto;\n    margin-bottom: 1em;\n  }\n\n  .response-content code {\n    font-family: var(--ai-font-mono);\n    font-size: 0.9em;\n    padding: 0.2em 0.4em;\n    background: var(--ai-surface-dark);\n    border-radius: var(--ai-radius-sm);\n  }\n\n  /* Mantener contenido estable */\n  .response-content p, \n  .response-content ul, \n  .response-content ol,\n  .response-content pre {\n    contain: layout;\n  }\n\n  /* Eliminar margen en el último elemento para mantener espaciado consistente */\n  .response-content > *:last-child {\n    margin-bottom: 0;\n  }\n\n  /* ===== ANIMACIÓN DE ESCRITURA ===== */\n  /* Deshabilitar el cursor por defecto */\n  .response-content::after {\n    content: none;\n  }\n\n  /* Cursor de escritura personalizado */\n  .typing-animation::after {\n    content: '|';\n    display: inline-block;\n    width: 0.5em;\n    height: 1.2em;\n    background: transparent;\n    margin-left: 1px;\n    border: none;\n    animation: typingCursor 0.8s infinite step-end;\n    vertical-align: middle;\n    position: relative;\n    opacity: 0.8;\n  }\n\n  /* Eliminar CUALQUIER cursor adicional */\n  .typing-animation span.typing,\n  .typing span.cursor,\n  span.typing-cursor {\n    display: none !important;\n    opacity: 0 !important;\n    visibility: hidden !important;\n  }\n\n  /* Animación del cursor */\n  @keyframes typingCursor {\n    0%, 100% { opacity: 0.8; }\n    50% { opacity: 0; }\n  }\n\n  /* Indicadores de carga */\n  .typing-indicator {\n    color: var(--ai-text-light);\n    font-style: italic;\n    padding: 0.25rem 0;\n    animation: fadeInOut 1.5s ease-in-out infinite;\n  }\n\n  /* Animación para indicadores de carga */\n  @keyframes fadeInOut {\n    0%, 100% { opacity: 0.7; }\n    50% { opacity: 1; }\n  }\n\n  /* Efecto de texto apareciendo gradualmente */\n  @keyframes textReveal {\n    from { opacity: 0; transform: translateY(5px); }\n    to { opacity: 1; transform: translateY(0); }\n  }\n\n  /* Mensajes de estado iniciales para contenido vacío */\n  .response-entry[data-action="chat-response"] .response-content:empty::after,\n  .response-entry[data-action="summarize"] .response-content:empty::after,\n  .response-entry[data-action="improve"] .response-content:empty::after,\n  .response-entry[data-action="expand"] .response-content:empty::after,\n  .response-entry[data-action="paraphrase"] .response-content:empty::after,\n  .response-entry[data-action="more-formal"] .response-content:empty::after,\n  .response-entry[data-action="more-casual"] .response-content:empty::after {\n    content: 'Pensando...';\n    color: var(--ai-text-light);\n    font-style: italic;\n  }\n\n  .response-entry[data-action="chat-response"] .response-content:empty::after {\n    content: 'Escribiendo respuesta...';\n  }\n\n  /* ===== CABECERA Y PIE DE RESPUESTA ===== */\n  .response-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 0.5rem;\n    color: var(--ai-text-secondary);\n  }\n\n  .response-footer {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 1rem 0 0;\n    gap: 1rem;\n    border-top: 1px solid var(--ai-border);\n  }\n\n  /* ===== BOTONES Y ACCIONES ===== */\n  .response-actions {\n    display: flex;\n    gap: 0.5rem;\n  }\n\n  .response-tools {\n    display: flex;\n    gap: 0.5rem;\n    flex-wrap: nowrap;\n    overflow-x: auto;\n    padding: 0 0.25rem;\n  }\n\n  .response-tools::-webkit-scrollbar {\n    height: 4px;\n  }\n\n  .response-tools::-webkit-scrollbar-track {\n    background: var(--ai-surface-light);\n    border-radius: 2px;\n  }\n\n  .response-tools::-webkit-scrollbar-thumb {\n    background: var(--ai-surface-dark);\n    border-radius: 2px;\n  }\n\n  .response-action,\n  .tool-button {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.5rem 1rem;\n    border: none;\n    border-radius: var(--ai-radius);\n    background: var(--ai-surface-dark);\n    color: var(--ai-text);\n    cursor: pointer;\n    font-size: 0.875rem;\n    transition: all 0.2s ease;\n    white-space: nowrap;\n  }\n\n  .response-action {\n    padding: 0.5rem;\n  }\n\n  .response-action:hover,\n  .tool-button:hover {\n    background: var(--ai-primary);\n    color: white;\n  }\n\n  .response-action svg,\n  .tool-button svg {\n    width: 16px;\n    height: 16px;\n  }\n\n  /* ===== IMÁGENES Y ADJUNTOS ===== */\n  .response-entry.with-image {\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: 1rem;\n    align-items: start;\n  }\n\n  .response-image-container {\n    width: 120px;\n  }\n\n  .image-preview {\n    width: 120px;\n    height: 120px;\n    border-radius: var(--ai-radius);\n    overflow: hidden;\n  }\n\n  .image-preview img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n  }\n\n  .response-content-with-image {\n    display: flex;\n    align-items: flex-start;\n    gap: 1rem;\n    margin: 1rem 0;\n  }\n\n  .response-image {\n    width: 100%;\n    height: 120px;\n    object-fit: cover;\n    border-radius: var(--ai-radius);\n    border: 1px solid var(--ai-border);\n  }\n\n  .response-image img {\n    width: 100%;\n    height: auto;\n    display: block;\n    object-fit: contain;\n  }\n\n  .image-filename {\n    font-size: 0.75rem;\n    color: var(--ai-text-light);\n    margin-top: 0.25rem;\n    text-align: center;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  /* Estilos para imágenes en las respuestas */\n  .response-entry img {\n    max-width: 100px;\n    max-height: 100px;\n    object-fit: contain;\n    border-radius: var(--ai-radius);\n    border: 1px solid var(--ai-border);\n  }\n\n  .response-content .image-preview-card {\n    flex-shrink: 0;\n    width: 100px;\n    margin: 0;\n  }\n\n  .response-content .image-preview-card img {\n    width: 100%;\n    height: 100px;\n    object-fit: cover;\n  }\n\n  .response-content .image-preview-filename {\n    font-size: 0.75rem;\n    color: var(--ai-text-light);\n    text-align: center;\n    margin-top: 0.25rem;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  /* ===== PREGUNTAS CON IMÁGENES ===== */\n  .question-container {\n    display: flex;\n    gap: 1rem;\n    align-items: flex-start;\n  }\n\n  .question-content {\n    flex: 1;\n    min-width: 0;\n  }\n\n  .question-image {\n    flex-shrink: 0;\n    width: 100px;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.25rem;\n  }\n\n  .question-image img {\n    width: 100px;\n    height: 100px;\n    object-fit: cover;\n    border-radius: var(--ai-radius);\n    border: 1px solid var(--ai-border);\n  }\n\n  .question-image .image-filename {\n    font-size: 0.75rem;\n    color: var(--ai-text-light);\n    max-width: 100px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    text-align: center;\n  }\n\n  .question-with-image {\n    display: flex;\n    gap: 1rem;\n    align-items: flex-start;\n    margin: 0.5rem 0;\n  }\n\n  /* ESTILO PARA MENSAJES DE INFORMACIÓN */\n.response-entry[data-action="info"],\n.response-entry[data-action="error"],\n.response-entry[data-action="chat-error"] {\n  background-color: var(--ai-surface-light, #f9fafb);\n  padding: 0.5rem 0.75rem !important; \n  display: flex !important;\n  align-items: center !important;\n  max-height: none !important;\n}\n\n.response-entry[data-action="info"] .response-header,\n.response-entry[data-action="error"] .response-header,\n.response-entry[data-action="chat-error"] .response-header {\n  display: none !important; /* Ocultar header para más compacidad */\n}\n\n/* ESTILO PARA PREGUNTAS */\n.response-entry[data-action="chat-question"] {\n  padding: 0.5rem 0.75rem !important;\n  max-height: none !important;\n}\n\n      \n      /* Optimizaciones de layout */\n      .response-container {\n        overflow-y: auto;\n        max-height: 100%;\n        padding: 0;\n        margin: 0;\n        display: flex;\n        flex-direction: column;\n      }\n      \n      /* Reducir tamaño de los contenedores de respuesta */\n      .response-entry {\n        margin-bottom: 0.75rem !important;\n        padding: 0.75rem !important;\n        border-radius: var(--ai-radius);\n        max-height: fit-content;\n        overflow: visible;\n      }\n      \n      /* Reducir margen entre elementos */\n      .response-content {\n        margin: 0.25rem 0 !important;\n        line-height: 1.4 !important;\n        padding: 0 !important;\n      }\n      \n      /* Ajustar espaciado de cabecera */\n      .response-header {\n        margin-bottom: 0.25rem !important;\n      }\n      \n      /* Ajustar espaciado de pie */\n      .response-footer {\n        padding-top: 0.5rem !important;\n        margin-top: 0.25rem !important;\n      }\n      \n      /* Optimizar espaciado de párrafos */\n      .response-content p,\n      .response-content ul,\n      .response-content ol {\n        margin: 0.25em 0 !important;\n      }\n      \n      /* Reducir margen en listas */\n      .response-content ul, \n      .response-content ol {\n        padding-left: 1.25em !important;\n      }\n      \n      /* Optimizar tamaño de imágenes */\n      .question-image img {\n        width: 80px !important;\n        height: 80px !important;\n      }\n      \n      /* Ajustar espaciado de preguntas con imágenes */\n      .question-container {\n        gap: 0.5rem !important;\n      }\n      \n      /* Optimizar tamaño de botones */\n      .response-action {\n        padding: 0.35rem !important;\n      }\n      \n      .tool-button {\n        padding: 0.35rem 0.75rem !important;\n      }\n      \n      /* Optimizar indicadores de escritura */\n      .typing-indicator {\n        padding: 0.125rem 0 !important;\n      }\n    `;const n=document.createElement("div");for(n.className="response-container",this.responses.forEach((e=>{n.appendChild(this.createResponseEntry(e))}));this.shadowRoot.firstChild;)this.shadowRoot.removeChild(this.shadowRoot.firstChild);this.shadowRoot.appendChild(e),this.shadowRoot.appendChild(n),this.responses.length>0&&requestAnimationFrame((()=>{n.scrollTop=n.scrollHeight}))}formatTimestamp(e){if(!e)return"";try{return console.log("[ResponseHistory] Formatting timestamp:",e),new Date(e).toLocaleTimeString(this.language||"en",{hour:"2-digit",minute:"2-digit"})}catch(n){return console.error("[ResponseHistory] Error formatting timestamp:",n),""}}}customElements.define("response-history",i);class a extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.tempImage=null}static get observedAttributes(){return["language","image-url","api-provider","initial-prompt","has-content","has-context"]}get language(){return this.getAttribute("language")||"en"}get translations(){return e[this.language]||e.en}get imageUrl(){return this.getAttribute("image-url")}get apiProvider(){return this.getAttribute("api-provider")||"openai"}get supportsImages(){return["openai","anthropic"].includes(this.apiProvider)}get initialPrompt(){return this.getAttribute("initial-prompt")||""}get hasContent(){return"true"===this.getAttribute("has-content")}get hasContext(){return"true"===this.getAttribute("has-context")}async connectedCallback(){this.render(),this.setupEventListeners(),this.imageUrl&&await this.handleImageUrl(this.imageUrl),this.setInitialPrompt()}attributeChangedCallback(e,n,t){if(n!==t)switch(e){case"language":this.updateTranslations();break;case"image-url":t&&this.handleImageUrl(t);break;case"api-provider":this.updateUploadVisibility();break;case"initial-prompt":case"has-content":case"has-context":this.updateInitialPrompt()}}setInitialPrompt(){var e,n,t,o;if(!this.shadowRoot)return;const r=this.shadowRoot.querySelector(".chat-input");if(!r)return;let i="";if(this.hasContent?i=(null==(n=null==(e=this.translations)?void 0:e.chat)?void 0:n.contentPrompt)||"Could you improve the text in the editor?":this.hasContext?i=(null==(o=null==(t=this.translations)?void 0:t.chat)?void 0:o.contextPrompt)||"Can you create a professional description based on this context?":this.initialPrompt&&(i=this.initialPrompt),i&&""===r.innerText.trim()&&(r.innerText=i,document.activeElement===r)){const e=window.getSelection(),n=document.createRange();n.selectNodeContents(r),n.collapse(!1),e.removeAllRanges(),e.addRange(n)}}updateInitialPrompt(){var e;const n=null==(e=this.shadowRoot)?void 0:e.querySelector(".chat-input");n&&""===n.innerText.trim()&&this.setInitialPrompt()}updateImagePreview(){const e=this.shadowRoot.querySelector(".image-preview-container");e&&e.remove()}render(){var e,n;const r=document.createElement("style");r.textContent=`\n      ${t}\n      ${o}\n      \n\n  .chat-form {\n    display: flex;\n    gap: 0.5rem;\n  }\n\n  .chat-container {\n  border: 1px solid var(--ai-border);\n    border-radius: 8px;\n    background: white;\n  }\n\n  .chat-input {\n    flex: 1;\n    padding: 0.75rem;\n    border: 1px solid var(--ai-border);\n    border-radius: var(--ai-radius);\n    font-family: var(--ai-font-sans);\n    transition: border-color 0.2s ease;\n  }\n\n  .chat-input:focus {\n    outline: none;\n    border-color: var(--ai-primary);\n  }\n\n  .chat-submit {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1rem;\n    background: var(--ai-primary);\n    color: white;\n    border: none;\n    border-radius: var(--ai-radius);\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  .chat-submit:hover {\n    background: var(--ai-primary-hover);\n  }\n\n      \n      .chat-form {\n        display: flex;\n        gap: 8px;\n        align-items: flex-start;\n        padding: 8px;\n      }\n      \n      .chat-input-container {\n        position: relative;\n        flex: 1;\n        display: flex;\n        align-items: flex-end;\n      }\n      \n      .chat-submit {\n        flex-shrink: 0;\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .chat-input {\n        flex: 1;\n        min-height: 24px;\n        max-height: 150px;\n        padding: 12px;\n        padding-right: 40px;\n        background: var(--ai-background);\n        color: var(--ai-text);\n        font-size: 14px;\n        line-height: 1.5;\n        overflow-y: auto;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n      }\n      \n      .chat-input:empty::before {\n        content: attr(data-placeholder);\n        color: var(--ai-text-light);\n      }\n      \n      .chat-input:focus {\n        outline: none;\n      }\n      \n      .chat-upload-button {\n        display: inline-flex;\n        cursor: pointer;\n        color: var(--ai-text-light);\n        width: 32px;\n        height: 32px;\n        background: lightgray;\n        padding: 0;\n        align-items: center;\n        justify-content: center;\n        border-radius: var(--ai-radius);\n        border: 0;\n        flex-shrink: 0;\n      }\n      \n      .chat-upload-button:hover {\n        color: var(--ai-text);\n      }\n      \n      .hidden {\n        display: none !important;\n      }\n    `;const i=`\n      <div class="chat-container">\n        <form class="chat-form">\n          <div class="chat-input-container">\n            <div class="chat-input" \n                 contenteditable="true" \n                 data-placeholder="${(null==(n=null==(e=this.translations)?void 0:e.chat)?void 0:n.placeholder)||"Ask a question..."}"\n                 role="textbox"\n                 aria-multiline="true"></div>\n          </div>\n          ${this.supportsImages?'\n            <label class="chat-upload-button" title="Upload image">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/>\n                <circle cx="9" cy="9" r="2"/>\n                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>\n              </svg>\n              <input type="file" accept="image/*" class="hidden" id="imageInput">\n            </label>\n          ':""}\n          <button type="submit" class="chat-submit">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M5 12h14"/>\n              <path d="m12 5 7 7-7 7"/>\n            </svg>\n          </button>\n        </form>\n      </div>\n    `;this.shadowRoot.innerHTML="",this.shadowRoot.appendChild(r),this.shadowRoot.appendChild(document.createRange().createContextualFragment(i))}setupEventListeners(){const e=this.shadowRoot.querySelector(".chat-form"),n=this.shadowRoot.querySelector(".chat-input"),t=this.shadowRoot.querySelector(".chat-upload-button"),o=this.shadowRoot.querySelector("#imageInput");e.addEventListener("submit",this.handleSubmit.bind(this)),n.addEventListener("keydown",(n=>{"Enter"!==n.key||n.shiftKey||(n.preventDefault(),e.dispatchEvent(new Event("submit")))})),n.addEventListener("focus",(()=>{""===n.innerText.trim()&&this.setInitialPrompt()})),t&&o&&(t.addEventListener("click",(e=>{e.stopPropagation()})),o.addEventListener("change",(e=>{this.handleFileSelect(e),e.target.value=""})))}handleFileSelect(e){const n=e.target.files[0];n&&(this.tempImage=n)}handleSubmit(e){e.preventDefault(),e.stopPropagation();const n=this.shadowRoot.querySelector(".chat-input"),t=n.innerText.trim();(t||this.tempImage)&&(this.dispatchEvent(new CustomEvent("chatMessage",{detail:{message:t,image:this.tempImage},bubbles:!0,composed:!0})),n.innerText="",this.tempImage=null)}updateTranslations(){var e,n;const t=this.shadowRoot.querySelector(".chat-input"),o=this.shadowRoot.querySelector(".chat-submit");t&&o&&(t.setAttribute("data-placeholder",(null==(n=null==(e=this.translations)?void 0:e.chat)?void 0:n.placeholder)||"Ask a question..."),o.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M5 12h14"/>\n          <path d="m12 5 7 7-7 7"/>\n        </svg>\n      '),this.updateInitialPrompt()}updateUploadVisibility(){const e=this.shadowRoot.querySelector(".chat-upload-button");e&&(e.style.display=this.supportsImages?"inline-flex":"none")}async handleImageUrl(e){try{const n=await fetch(e),t=await n.blob(),o=new File([t],"image.jpg",{type:t.type});this.tempImage=o,this.updateImagePreview()}catch(n){console.error("Error loading image:",n)}}}customElements.define("chat-with-image",a);class s extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.currentAction="improve"}static get observedAttributes(){return["has-content","language"]}get hasContent(){return"true"===this.getAttribute("has-content")}get language(){return this.getAttribute("language")||"en"}get translations(){return e[this.language]||e.en}connectedCallback(){this.render(),this.bindEvents()}attributeChangedCallback(e,n,t){n!==t&&("language"===e?this.render():"has-content"===e&&this.updateVisibleTools())}render(){const e=document.createElement("style");e.textContent="\n      :host {\n        display: block;\n      }\n\n      .tools {\n        display: flex;\n        gap: 8px;\n        margin-bottom: 16px;\n        flex-wrap: wrap;\n      }\n\n      .tool-button {\n        display: inline-flex;\n        align-items: center;\n        gap: 8px;\n        padding: 8px 16px;\n        border: none;\n        border-radius: 6px;\n        background: #e5e7eb;\n        cursor: pointer;\n        font-family: inherit;\n      }\n\n      .tool-button:hover {\n        background: #d1d5db;\n      }\n\n      .tool-button.active {\n        background: #3b82f6;\n        color: white;\n      }\n\n      .tool-button svg {\n        width: 16px;\n        height: 16px;\n      }\n    ",this.shadowRoot.innerHTML="",this.shadowRoot.appendChild(e),this.shadowRoot.appendChild(this.createToolbar()),requestAnimationFrame((()=>{this.updateVisibleTools()}))}createToolbar(){const e=document.createElement("div");e.className="tools";return[{action:"improve",label:this.translations.tools.improve},{action:"summarize",label:this.translations.tools.summarize},{action:"expand",label:this.translations.tools.expand},{action:"paraphrase",label:this.translations.tools.paraphrase},{action:"more-formal",label:this.translations.tools["more-formal"]||this.translations.tools.formal},{action:"more-casual",label:this.translations.tools["more-casual"]||this.translations.tools.casual}].forEach((t=>{const o=document.createElement("button");o.className="tool-button",o.dataset.action=t.action;const r=t.label||t.action;o.innerHTML=`${n(t.action)}${r}`,e.appendChild(o)})),e}bindEvents(){this.shadowRoot.querySelectorAll(".tool-button").forEach((e=>{e.onclick=()=>{this.setActiveAction(e.dataset.action),this.dispatchEvent(new CustomEvent("toolaction",{detail:{action:e.dataset.action},bubbles:!0,composed:!0}))}}))}setActiveAction(e){this.currentAction=e,this.shadowRoot.querySelectorAll(".tool-button").forEach((n=>{n.classList.toggle("active",n.dataset.action===e)}))}updateVisibleTools(){const e=this.hasContent,t=this.shadowRoot.querySelector('[data-action="improve"]'),o=this.shadowRoot.querySelectorAll(".tool-button");t.innerHTML=e?`${n("improve")}${this.translations.tools.improve}`:`\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>\n          <path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/>\n        </svg>\n        ${this.translations.tools.generate||"Generate"}\n      `,o.forEach((n=>{const t=n.dataset.action;n.style.display=e||"improve"===t?"inline-flex":"none"}))}getCurrentAction(){return this.currentAction}}customElements.define("ai-toolbar",s);const l={openai:{models:{"gpt-4-turbo":{name:"GPT-4 Turbo",contextWindow:128e3,description:"Latest GPT-4 model with larger context window",suggested:!0,maxTokens:4096,costPer1k:.01,supportsImages:!0},"gpt-4":{name:"GPT-4",contextWindow:8192,description:"Most capable GPT-4 model",maxTokens:4096,costPer1k:.03,supportsImages:!0},"gpt-3.5-turbo":{name:"GPT-3.5 Turbo",contextWindow:16385,description:"Efficient and cost-effective model",maxTokens:4096,costPer1k:.0015,supportsImages:!1}},defaultModel:"gpt-4-turbo",visionModel:"gpt-4-turbo"},anthropic:{models:{"claude-3-opus-20240229":{name:"Claude 3 Opus",contextWindow:2e5,description:"Most capable Claude model",suggested:!0,supportsImages:!0},"claude-3-sonnet-20240229":{name:"Claude 3 Sonnet",contextWindow:2e5,description:"Balance of intelligence and speed",supportsImages:!0}},defaultModel:"claude-3-opus-20240229",visionModel:"claude-3-opus-20240229"},deepseek:{models:{"deepseek-chat":{name:"DeepSeek Chat",contextWindow:32768,description:"General purpose chat model",suggested:!0,maxTokens:4096},"deepseek-coder":{name:"DeepSeek Coder",contextWindow:32768,description:"Specialized in code generation",maxTokens:4096}},defaultModel:"deepseek-chat"},cohere:{models:{command:{name:"Command",contextWindow:4096,description:"Latest generation model",suggested:!0,maxTokens:4096},"command-light":{name:"Command Light",contextWindow:4096,description:"Faster, more efficient model",maxTokens:4096},"command-nightly":{name:"Command Nightly",contextWindow:4096,description:"Experimental features",maxTokens:4096}},defaultModel:"command"},google:{models:{"gemini-pro":{name:"Gemini Pro",contextWindow:32768,description:"Most capable Gemini model",suggested:!0,maxTokens:4096,supportsImages:!1},"gemini-pro-vision":{name:"Gemini Pro Vision",contextWindow:32768,description:"Multimodal capabilities",maxTokens:4096,supportsImages:!0}},defaultModel:"gemini-pro",visionModel:"gemini-pro-vision"},mistral:{models:{"mistral-large-latest":{name:"Mistral Large",contextWindow:32768,description:"Most capable Mistral model",suggested:!0,maxTokens:4096},"mistral-medium-latest":{name:"Mistral Medium",contextWindow:32768,description:"Balanced performance",maxTokens:4096},"mistral-small-latest":{name:"Mistral Small",contextWindow:32768,description:"Fast and efficient",maxTokens:4096}},defaultModel:"mistral-large-latest"},ollama:{models:{llama2:{name:"Llama 2",contextWindow:4096,description:"Default Llama 2 model",suggested:!0,maxTokens:4096},"llama2:13b":{name:"Llama 2 13B",contextWindow:4096,description:"Balanced 13B parameter model",maxTokens:4096},"llama2:70b":{name:"Llama 2 70B",contextWindow:4096,description:"Large 70B parameter model",maxTokens:4096},mistral:{name:"Mistral",contextWindow:8192,description:"Mistral base model",maxTokens:4096},mixtral:{name:"Mixtral",contextWindow:32768,description:"Mixtral 8x7B model",maxTokens:4096}},defaultModel:"llama2"}};class d{constructor(e="openai"){this.provider=e,this.config=l}getModelConfig(e){const n=this.config[this.provider];if(!n)throw new Error(`Provider ${this.provider} not supported`);return e&&n.models[e]?n.models[e]:n.models[n.default]}getDefaultModel(){const e=this.config[this.provider];if(!e)throw new Error(`Provider ${this.provider} not supported`);return e.default}getAllModels(){const e=this.config[this.provider];if(!e)throw new Error(`Provider ${this.provider} not supported`);return Object.values(e.models)}isProviderSupported(e){return!!this.config[e]}isImageSupportedForProvider(e){const n=this.config[e];return!!n&&(!!n.visionModel||["openai","anthropic","google"].includes(e))}getVisionModelForProvider(e){const n=this.config[e];return n?n.visionModel?n.visionModel:n.defaultModel:null}setProvider(e){if(!this.isProviderSupported(e))throw new Error(`Provider ${e} not supported`);this.provider=e}}class c{constructor(){this.modelManager=new d,this.tokensPerChar={en:.25,es:.28,fr:.28,de:.3,zh:.5,ja:.5},this.defaultTokensPerChar=.25}}class p{constructor(){this.marked=null}async initialize(){try{const{marked:e}=await import("https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js");this.marked=e,this.marked.setOptions({gfm:!0,breaks:!0,sanitize:!1})}catch(e){throw console.error("Error initializing markdown handler:",e),e}}convert(e){return e&&this.marked?this.marked(e):e}}class h{constructor(e={}){this.modelManager=new d(e.provider||"openai"),this.config={provider:e.provider||"openai",proxyEndpoint:e.proxyEndpoint||"http://llmproxy.test:8080/api/llm-proxy",models:{openai:e.model||"gpt-4-turbo",deepseek:"deepseek-chat",anthropic:"claude-3-opus-20240229",cohere:"command",google:"gemini-pro",mistral:"mistral-large-latest"},visionModels:{openai:"gpt-4-turbo",anthropic:"claude-3-opus-20240229"},temperature:e.temperature||.7,sessionToken:e.sessionToken||"",systemPrompt:e.systemPrompt||"Actúa como un experto en redacción de descripciones de productos para tiendas en línea.\n\nTu tarea es generar o mejorar la descripción de un producto con un enfoque atractivo y persuasivo, destacando sus características principales, beneficios y posibles usos.\n\nSi el usuario ya ha escrito una descripción: Mejórala manteniendo su esencia, pero haciéndola más clara, persuasiva y optimizada para ventas.\n\nSi la descripción está vacía: Genera una nueva descripción atractiva, destacando características y beneficios. Usa un tono profesional y cercano, adaptado a una tienda en línea.\n\nSi hay una imagen del producto, aprovecha los detalles visuales para enriquecer la descripción.\n\nSi aplica, menciona información relevante del comercio para reforzar la confianza del comprador (envíos, garantía, atención al cliente, etc.).\n\nMantén el texto claro, sin repeticiones innecesarias, y optimizado para SEO si es posible.",tenantId:e.tenantId||"",userId:e.userId||""}}setSessionToken(e){this.config.sessionToken=e}setProvider(e){if(!this.modelManager.isProviderSupported(e))throw new Error(`Provider ${e} not supported`);this.config.provider=e,this.modelManager.setProvider(e),this.config.models[e]=this.modelManager.getDefaultModel()}setModel(e){e&&(this.config.models[this.config.provider]=e)}updateConfig(e){e.provider&&this.setProvider(e.provider),e.model&&this.setModel(e.model),e.sessionToken&&this.setSessionToken(e.sessionToken),e.tenantId&&(this.config.tenantId=e.tenantId),e.userId&&(this.config.userId=e.userId),e.proxyEndpoint&&(this.config.proxyEndpoint=e.proxyEndpoint)}async processStream(e,n){const t=e.body.getReader(),o=new TextDecoder;let r="",i="",a=!1;try{for(console.log("Iniciando procesamiento de stream");;){const{done:e,value:d}=await t.read();if(e){console.log("Stream completado"),r.trim()&&(i+=r.trim(),n(r.trim()));break}const c=o.decode(d,{stream:!0});console.log("Fragmento raw recibido:",c),r+=c;const p=r.split("\n");r=p.pop()||"";for(const t of p)if(t.startsWith("data: ")){const e=t.slice(5).trim();if("[DONE]"===e)continue;try{const t=JSON.parse(e);let o="";t.choices&&t.choices[0].delta&&t.choices[0].delta.content?o=t.choices[0].delta.content:t.text?o=t.text:t.content?o=t.content:t.delta&&t.delta.text&&(o=t.delta.text),o&&(i+=o,n(o),a=!0)}catch(s){if(console.error("Error procesando JSON:",s),e.includes('"text":"')||e.includes('"content":"'))try{const t=e.match(/"(text|content)":"([^"]*)"/);if(t&&t[2]){const e=t[2];i+=e,n(e),a=!0}}catch(l){console.error("Error extrayendo texto:",l)}}}if(!a&&r.trim()){let e=r.trim();try{const n=r.match(/"(text|content)":"([^"]*)"/);n&&n[2]&&(e=n[2])}catch(s){console.log("Error extrayendo texto del buffer:",s)}i+=e,n(e),a=!0}}return i}catch(d){throw console.error("Error en procesamiento de stream:",d),d}}async makeRequest(e,n,t=()=>{}){var o;try{const r=this.config.models[this.config.provider];if(!r)throw new Error("Model not configured for provider");const i={provider:this.config.provider,model:r,messages:[{role:"system",content:this.config.systemPrompt},{role:"user",content:`${e}\n\n${n||"Crea una nueva descripción."}`}],temperature:this.config.temperature,stream:!0,tenantId:this.config.tenantId,userId:this.config.userId};console.log("Enviando solicitud al proxy:",this.config.proxyEndpoint),console.log("Payload:",i);const a=await fetch(this.config.proxyEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(console.log("Respuesta del proxy:",{status:a.status,ok:a.ok,headers:Object.fromEntries([...a.headers.entries()])}),!a.ok){const e=await a.json().catch((()=>({})));throw new Error((null==(o=e.error)?void 0:o.message)||`API Error: ${a.status} ${a.statusText}`)}return await this.processStream(a,t)}catch(r){throw console.error("Error al hacer la solicitud:",r),new m(r.message,r)}}async makeRequestWithImage(e,n,t,o=()=>{}){var r;try{let a,s,l="image/jpeg";if("string"==typeof t)s=t;else{if(!(t instanceof File))throw new Error("Invalid image source");a=await this.imageToBase64(t),l=t.type||l,console.log("Image file type:",l)}const d=[];"openai"===this.config.provider?(d.push({role:"system",content:this.config.systemPrompt}),d.push({role:"user",content:[{type:"text",text:`${e}\n\n${n||"Please create a new description."}`},{type:"image_url",image_url:s?{url:s,detail:"high"}:{url:`data:${l};base64,${a}`,detail:"high"}}]})):"anthropic"===this.config.provider?d.push({role:"user",content:[{type:"text",text:this.config.systemPrompt},{type:"image",source:s?{type:"url",url:s}:{type:"base64",media_type:l,data:a}},{type:"text",text:`${e}\n\n${n||"Please create a new description."}`}]}):"google"===this.config.provider&&d.push({role:"user",parts:[{text:`${this.config.systemPrompt}\n\n${e}\n\n${n||"Please create a new description."}`},{inline_data:{mime_type:l,data:a}}]});const c=this.modelManager.getVisionModelForProvider(this.config.provider),p={provider:this.config.provider,model:c||this.config.models[this.config.provider],messages:d,temperature:this.config.temperature,stream:!0,tenantId:this.config.tenantId,userId:this.config.userId,hasImage:!0};console.log("Sending image request to proxy:",{endpoint:this.config.proxyEndpoint,provider:this.config.provider,model:p.model,hasImage:!0,imageType:l});const h=await fetch(this.config.proxyEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.config.sessionToken&&{Authorization:`Bearer ${this.config.sessionToken}`}},body:JSON.stringify(p)});if(console.log("Image request response status:",h.status,h.statusText),!h.ok)try{const e=await h.json();throw console.error("Image API Error Response:",e),new Error((null==(r=e.error)?void 0:r.message)||`API Error: ${h.status} ${h.statusText}`)}catch(i){console.error("Failed to parse error response:",i);const e=await h.text().catch((()=>""));throw console.error("Raw error response:",e),new Error(`API Error: ${h.status} ${h.statusText}`)}return await this.processStream(h,o)}catch(a){throw console.error("Image processing error:",a),new Error(`Image processing failed: ${a.message}`)}}async imageToBase64(e){if(!e)throw new Error("No image file provided");if(!e.type.startsWith("image/"))throw new Error("Invalid file type. Please provide an image file.");return new Promise(((n,t)=>{const o=new FileReader;o.onload=()=>{try{const e=o.result.split(",")[1];if(!e)return void t(new Error("Failed to convert image to base64"));n(e)}catch(e){t(new Error("Failed to process image data"))}},o.onerror=()=>t(new Error("Failed to read image file")),o.readAsDataURL(e)}))}async enhanceText(e,n="improve",t=null,o="",r=()=>{}){const i={improve:`Mejora esta descripción considerando estos detalles del producto:\n${o}\n\nDescripción actual:`,summarize:`Teniendo en cuenta estos detalles del producto:\n${o}\n\nCrea un resumen conciso y efectivo de la siguiente descripción:`,expand:`Basándote en estos detalles del producto:\n${o}\n\nExpande esta descripción añadiendo más detalles, beneficios y casos de uso:`,paraphrase:`Considerando estos detalles del producto:\n${o}\n\nReescribe esta descripción manteniendo el mensaje principal pero con un enfoque fresco:`,"more-formal":`Usando estos detalles del producto:\n${o}\n\nReescribe esta descripción con un tono más formal, profesional y técnico, manteniendo la información clave pero usando un lenguaje más sofisticado y corporativo:`,"more-casual":`Usando estos detalles del producto:\n${o}\n\nReescribe esta descripción con un tono más casual y cercano, como si estuvieras explicándolo a un amigo, manteniendo un lenguaje accesible y conversacional pero sin perder profesionalismo:`,empty:`Usando estos detalles del producto:\n${o}\n\nCrea una descripción profesional y atractiva que destaque sus características principales:`},a=i[n]||i.improve,s=e=>{e&&r(e)};try{return t&&this.modelManager.isImageSupportedForProvider(this.config.provider)?await this.makeRequestWithImage(a,e,t,s):await this.makeRequest(a,e,s)}catch(l){throw console.error("Error in enhanceText:",l),new Error(`Error al mejorar el texto: ${l.message}`)}}async chatResponse(e,n,t=null,o=()=>{}){var r;try{let s=[{role:"system",content:this.config.systemPrompt},{role:"user",content:e}],l=!1;if(n)if(t&&this.modelManager.isImageSupportedForProvider(this.config.provider))try{const e=await this.imageToBase64(t),o=t.type||"image/jpeg";console.log("Chat with image - file type:",o),l=!0,"openai"===this.config.provider?s.push({role:"user",content:[{type:"text",text:n},{type:"image_url",image_url:{url:`data:${o};base64,${e}`,detail:"auto"}}]}):"anthropic"===this.config.provider?s.push({role:"user",content:[{type:"text",text:n},{type:"image",source:{type:"base64",media_type:o,data:e}}]}):"google"===this.config.provider?s.push({role:"user",parts:[{text:n},{inline_data:{mime_type:o,data:e}}]}):(s.push({role:"user",content:n}),l=!1)}catch(i){console.error("Failed to process image for chat:",i),s.push({role:"user",content:n}),l=!1}else s.push({role:"user",content:n});const d=l?this.modelManager.getVisionModelForProvider(this.config.provider):this.config.models[this.config.provider],c={provider:this.config.provider,model:d,messages:s,temperature:this.config.temperature,stream:!0,tenantId:this.config.tenantId,userId:this.config.userId,hasImage:l};console.log("Sending chat request to proxy:",{endpoint:this.config.proxyEndpoint,provider:this.config.provider,model:c.model,hasImage:l});const p=await fetch(this.config.proxyEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.config.sessionToken&&{Authorization:`Bearer ${this.config.sessionToken}`}},body:JSON.stringify(c)});if(console.log("Chat response status:",p.status,p.statusText),!p.ok)try{const e=await p.json();throw console.error("Chat API Error Response:",e),new Error((null==(r=e.error)?void 0:r.message)||`API Error: ${p.status} ${p.statusText}`)}catch(a){console.error("Failed to parse error response:",a);const e=await p.text().catch((()=>""));throw console.error("Raw error response:",e),new Error(`API Error: ${p.status} ${p.statusText}`)}return await this.processStream(p,o)}catch(s){throw console.error("Chat response error:",s),new m(`Chat response failed: ${s.message}`,s)}}get supportsImages(){return this.modelManager.isImageSupportedForProvider(this.config.provider)}}class m extends Error{constructor(e,n=null){super(e),this.name="APIError",this.originalError=n}}class u{constructor(e={}){this.options={prefix:e.prefix||"ai-text-enhancer-cache",maxItems:e.maxItems||20,ttl:e.ttl||18e5,storage:e.storage||window.sessionStorage},this.validateStorage()}validateStorage(){try{const e=`${this.options.prefix}-test`;this.options.storage.setItem(e,"test"),this.options.storage.removeItem(e)}catch(e){throw new Error("Storage is not available: "+e.message)}}generateKey(e,n){const t=this.hashString(n);return`${this.options.prefix}-${e}-${t}`}hashString(e){let n=0;for(let t=0;t<e.length;t++){n=(n<<5)-n+e.charCodeAt(t),n|=0}return Math.abs(n).toString(36)}get(e,n){try{const t=this.generateKey(e,n),o=this.options.storage.getItem(t);if(!o)return null;const r=JSON.parse(o);return Date.now()-r.timestamp>this.options.ttl?(this.delete(e,n),null):r.value}catch(t){return console.error("Error reading from cache:",t),null}}set(e,n,t){try{const o=this.generateKey(e,n),r={value:t,timestamp:Date.now()};this.enforceSizeLimit(),this.options.storage.setItem(o,JSON.stringify(r))}catch(o){console.error("Error writing to cache:",o),this.cleanup()}}delete(e,n){const t=this.generateKey(e,n);this.options.storage.removeItem(t)}enforceSizeLimit(){try{const e=this.getCacheKeys();if(e.length>=this.options.maxItems){e.map((e=>({key:e,timestamp:JSON.parse(this.options.storage.getItem(e)).timestamp}))).sort(((e,n)=>e.timestamp-n.timestamp)).slice(0,e.length-this.options.maxItems+1).forEach((e=>{this.options.storage.removeItem(e.key)}))}}catch(e){console.error("Error enforcing cache size limit:",e)}}getCacheKeys(){const e=[];for(let n=0;n<this.options.storage.length;n++){const t=this.options.storage.key(n);t.startsWith(this.options.prefix)&&e.push(t)}return e}cleanup(){try{const e=Date.now();this.getCacheKeys().forEach((n=>{const t=JSON.parse(this.options.storage.getItem(n));e-t.timestamp>this.options.ttl&&this.options.storage.removeItem(n)}))}catch(e){console.error("Error during cache cleanup:",e)}}clear(){this.getCacheKeys().forEach((e=>{this.options.storage.removeItem(e)}))}getStats(){try{const e=this.getCacheKeys(),n=Date.now();let t=0,o=0;return e.forEach((e=>{const r=JSON.parse(this.options.storage.getItem(e));t+=JSON.stringify(r).length,n-r.timestamp>this.options.ttl&&o++})),{totalItems:e.length,expiredItems:o,totalSize:t,maxItems:this.options.maxItems}}catch(e){return console.error("Error getting cache stats:",e),null}}}class g{constructor(e){console.log("[EditorAdapter] Initializing with editor ID:",e),this.editorId=e,this.editor=document.getElementById(e),this.editor||console.error("[EditorAdapter] Editor element not found:",e)}getContent(){return console.log("[EditorAdapter] Getting content from editor"),this.editor&&(this.editor.value||this.editor.textContent)||""}setContent(e){console.log("[EditorAdapter] Setting content to editor:",e),this.editor?(void 0!==this.editor.value?this.editor.value=e:this.editor.textContent=e,this.editor.dispatchEvent(new Event("change",{bubbles:!0}))):console.error("[EditorAdapter] Editor not available")}}class v{constructor(e){if(!e)return console.error("[NotificationManager] No se proporcionó un contenedor"),void(this.container=null);e.shadowRoot?(this.container=e.shadowRoot.querySelector(".notifications-container"),this.container||(this.container=document.createElement("div"),this.container.className="notifications-container",e.shadowRoot.appendChild(this.container))):this.container=e,this.notifications=new Set,console.log("[NotificationManager] Inicializado con contenedor:",this.container)}show(e,n="info",t=5e3){if(!this.container)return console.error("[NotificationManager] No hay contenedor de notificaciones disponible"),console.log(`[${n.toUpperCase()}] ${e}`),null;try{const o=document.createElement("div");o.className=`ai-notification ${n}`,o.setAttribute("role","alert");const r=this.getIconForType(n);o.innerHTML=`\n        ${r}\n        <div class="notification-content">${e}</div>\n        <button class="notification-close" aria-label="Close notification">\n          <svg width="16" height="16" viewBox="0 0 16 16">\n            <path d="M4 4l8 8m0-8l-8 8" stroke="currentColor" stroke-width="2"/>\n          </svg>\n        </button>\n      `;const i=()=>{o.style.animation="slideOut 0.3s ease-out",setTimeout((()=>{o.parentNode&&o.remove(),this.notifications.delete(o)}),300)},a=o.querySelector(".notification-close");return a&&(a.onclick=i),t>0&&setTimeout(i,t),this.container.appendChild(o),this.notifications.add(o),console.log(`[NotificationManager] Notificación mostrada: ${n}`),this.cleanupOldNotifications(),o}catch(o){return console.error("[NotificationManager] Error al mostrar notificación:",o),null}}error(e,n=7e3){return this.show(e,"error",n)}warning(e,n=5e3){return this.show(e,"warning",n)}info(e,n=4e3){return this.show(e,"info",n)}success(e,n=3e3){return this.show(e,"success",n)}cleanupOldNotifications(e=3){const n=Array.from(this.notifications);if(n.length>e){n.slice(0,n.length-e).forEach((e=>{e.parentNode&&e.remove(),this.notifications.delete(e)}))}}getIconForType(e){switch(e){case"error":return'\n          <svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="12" cy="12" r="10"/>\n            <line x1="12" y1="8" x2="12" y2="12"/>\n            <line x1="12" y1="16" x2="12.01" y2="16"/>\n          </svg>\n        ';case"warning":return'\n          <svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>\n            <line x1="12" y1="9" x2="12" y2="13"/>\n            <line x1="12" y1="17" x2="12.01" y2="17"/>\n          </svg>\n        ';case"success":return'\n          <svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>\n            <polyline points="22 4 12 14.01 9 11.01"/>\n          </svg>\n        ';default:return'\n          <svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="12" cy="12" r="10"/>\n            <line x1="12" y1="16" x2="12" y2="12"/>\n            <line x1="12" y1="8" x2="12.01" y2="8"/>\n          </svg>\n        '}}clearAll(){this.notifications.forEach((e=>{e.parentNode&&e.remove()})),this.notifications.clear()}}const f={handleKeyboard(e){if(e.ctrlKey||e.metaKey)switch(e.key.toLowerCase()){case"e":e.preventDefault(),this.shadowRoot.querySelector(".modal-trigger").click();break;case"i":e.preventDefault(),this.isModalOpen()&&this.handleToolAction("improve");break;case"s":e.preventDefault(),this.isModalOpen()&&this.handleToolAction("summarize")}},handleModalKeyboard(e){if(this.isModalOpen())switch(e.key){case"Escape":this.shadowRoot.querySelector(".close-button").click();break;case"Tab":this.handleTabNavigation(e);break;case"ArrowRight":case"ArrowLeft":e.target.closest(".tools-container")&&this.handleToolNavigation(e)}},handleTabNavigation(e){const n=this.shadowRoot.querySelector(".modal").querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),t=n[0],o=n[n.length-1];e.shiftKey?document.activeElement===t&&(e.preventDefault(),o.focus()):document.activeElement===o&&(e.preventDefault(),t.focus())},handleToolNavigation(e){const n=this.shadowRoot.querySelector("ai-toolbar"),t=n.shadowRoot.querySelectorAll(".tool-button"),o=n.shadowRoot.querySelector(".tool-button:focus");if(!o)return;const r=Array.from(t).indexOf(o);let i;i="ArrowRight"===e.key?(r+1)%t.length:(r-1+t.length)%t.length,t[i].focus(),e.preventDefault()}},y={handleResponseCopy(e){var n;console.log("[ResponseHandlers] Copy event received:",e.detail);const{responseId:t}=e.detail,o=null==(n=this.responseHistory)?void 0:n.getResponse(t);o?navigator.clipboard.writeText(o.content).then((()=>console.log("[ResponseHandlers] Content copied to clipboard"))).catch((e=>console.error("[ResponseHandlers] Copy failed:",e))):console.warn("[ResponseHandlers] No response found for ID:",t)},handleResponseUse(e){console.log("[ResponseHandlers] Use event received:",e.detail);const{responseId:n}=e.detail;if(!this.responseHistory)return void console.error("[ResponseHandlers] No response history available");if(!this.editorAdapter)return void console.error("[ResponseHandlers] No editor adapter available");const t=this.responseHistory.getResponse(n);if(console.log("[ResponseHandlers] Found response:",t),t)try{console.log("[ResponseHandlers] Setting content to editor:",t.content),this.editorAdapter.setContent(t.content)}catch(o){console.error("[ResponseHandlers] Error setting content:",o)}else console.warn("[ResponseHandlers] No response found for ID:",n)},handleResponseRetry(e){var n;console.log("[ResponseHandlers] Retry event received:",e.detail);const{responseId:t}=e.detail,o=null==(n=this.responseHistory)?void 0:n.getResponse(t);o?(console.log("[ResponseHandlers] Retrying action:",o.action),this.handleToolAction(o.action)):console.warn("[ResponseHandlers] No response found for ID:",t)}},b={isImageUsed(e){if(!this.responseHistory)return!1;const n=e instanceof File?e.name:e;return this.responseHistory.responses.some((e=>"image-upload"!==e.action&&e.imageUsed===n))},handleImageChange(e){if(e){this.productImage=e,this.productImageUrl=null;const n=this.responseHistory.responses.findLast((e=>"chat-question"===e.action));if(n){const t=this.renderImagePreview(e),o=this.shadowRoot.querySelector(`.response-entry[data-response-id="${n.id}"]`);if(o){const e=o.querySelector(".response-content");e&&e.insertAdjacentHTML("beforeend",t)}this.shadowRoot.querySelectorAll('.response-entry[data-action="image-upload"]').forEach((e=>e.remove())),this.responseHistory.responses=this.responseHistory.responses.filter((e=>"image-upload"!==e.action))}}},removeImage(){if(this.productImage||this.productImageUrl){this.productImage=null,this.productImageUrl=null;const e=this.responseHistory.responses.findLast((e=>"chat-question"===e.action));e&&(e.content=e.content.replace(/<div class="image-preview-card"[\s\S]*?<\/div><\/div><\/div>/g,""),this.responseHistory&&this.responseHistory.render())}},renderImagePreview(e=null,n=!1){const t=e||this.productImage||this.productImageUrl;if(!t)return"";const o=t instanceof File?URL.createObjectURL(t):t,r=t instanceof File?t.name:new URL(t).pathname.split("/").pop()||"From URL";return`\n      <div class="image-preview-card" \n           data-image-id="${Date.now()}"\n           role="figure"\n           aria-label="${n?"Initial product image":"Uploaded product image"}">\n        <div class="image-preview-content">\n          <div class="image-preview-thumbnail">\n            <img src="${o}" alt="Product preview - ${r}">\n          </div>\n        </div>\n      </div>\n    `}},x={initializeStateManager(){this.stateManager=(e=>{const n={};return{updateState(t,o,r={}){const i=n[t];if(n[t]=o,e.dispatchEvent(new CustomEvent("stateChange",{detail:{property:t,oldValue:i,newValue:o},bubbles:!1})),r.rerender&&e.shadowRoot)if(r.targetSelector){const n=e.shadowRoot.querySelector(r.targetSelector);n&&"function"==typeof e.renderPart&&e.renderPart(n,t)}else"function"==typeof e.render&&e.render();return o},getState:(e,t=null)=>e in n?n[e]:t,getAllState:()=>({...n}),batchUpdate(t,o={}){const r=[];for(const[e,i]of Object.entries(t)){const t=n[e];t!==i&&(n[e]=i,r.push({property:e,oldValue:t,newValue:i}))}if(r.length>0&&(e.dispatchEvent(new CustomEvent("stateBatchChange",{detail:{changes:r},bubbles:!1})),o.rerender&&e.shadowRoot))if(o.targetSelector&&"function"==typeof e.renderPart){const n=e.shadowRoot.querySelector(o.targetSelector);n&&e.renderPart(n,r.map((e=>e.property)))}else"function"==typeof e.render&&e.render();return r.length>0}}})(this),this.addEventListener("stateChange",this.handleStateChange.bind(this)),this.addEventListener("stateBatchChange",this.handleStateBatchChange.bind(this))},handleStateChange(e){const{property:n,oldValue:t,newValue:o}=e.detail;switch(console.log(`[StateManager] Property '${n}' changed:`,t,"->",o),n){case"productImage":this.handleProductImageChange(t,o);break;case"enhancedText":this.handleEnhancedTextChange(t,o)}},handleStateBatchChange(e){console.log("[StateManager] Batch state change:",e.detail.changes);if(e.detail.changes.map((e=>e.property)).includes("productImage")){const n=e.detail.changes.find((e=>"productImage"===e.property));this.handleProductImageChange(n.oldValue,n.newValue)}},handleProductImageChange(e,n){if(n){if(console.log("[StateManager] New product image set:",n.name),this.responseHistory){this.responseHistory.responses.findLast((e=>"chat-question"===e.action))&&this.responseHistory.render()}}else e&&console.log("[StateManager] Product image removed")},handleEnhancedTextChange(e,n){console.log("[StateManager] Enhanced text updated")},requestUpdate(e=null){if(console.log("[StateManager] Update requested for:",e||"entire component"),!e)return this.responseHistory&&this.responseHistory.render(),void this.updateVisibleTools();switch(e){case"responseHistory":this.responseHistory&&this.responseHistory.render();break;case"toolbar":this.updateVisibleTools()}}};function w(e){if(!e)return console.error("[createTemplate] Error: No se proporcionó un componente"),"";try{console.log("[createTemplate] Creando template para el componente",e.tagName);const n=e.translations||{},i="function"==typeof e.currentContent?e.currentContent():e.currentContent||"",a=e.context||"",s=Boolean((null==i?void 0:i.trim)&&i.trim()),l=Boolean((null==a?void 0:a.trim)&&a.trim());return console.log("[createTemplate] Estado del contenido:",{hasContent:s,hasContext:l,language:e.language||"en"}),`\n    \x3c!-- Estilos del componente --\x3e\n    <style>\n      ${t}\n      ${o}\n      \n  .modal-trigger {\n    position: relative;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0.75rem 1.25rem;\n    background: linear-gradient(to right, var(--ai-gradient-start) 0%, var(--ai-gradient-middle) 51%, var(--ai-gradient-end) 100%);\n    background-size: 200% auto;\n    border: 0;\n    border-radius: 2em;\n    color: white;\n    font-family: var(--ai-font-sans);\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n    white-space: nowrap;\n    box-shadow: var(--ai-shadow);\n  }\n\n  .modal-trigger::before {\n    content: "";\n    position: absolute;\n    inset: 0;\n    opacity: 0;\n    background: linear-gradient(45deg, #fb0094, #0000ff, #00ff00, #ffff00, #ff0000);\n    background-size: 400%;\n    border-radius: 2em;\n    z-index: -1;\n    transition: opacity 0.3s ease;\n    animation: glow 5s linear infinite;\n  }\n\n  .modal-trigger:hover {\n    background-position: right center;\n    box-shadow: var(--ai-shadow-md);\n    transform: translateY(-1px);\n  }\n\n  .modal-trigger:hover::before {\n    opacity: 0.7;\n    filter: blur(8px);\n  }\n\n  .modal-trigger svg {\n    width: 1.25em;\n    height: 1.25em;\n    margin-right: 0.5em;\n    transition: transform 0.3s ease;\n  }\n\n  .modal-trigger:hover svg {\n    animation: shake 0.5s ease-in-out;\n  }\n\n  .modal-trigger span {\n    font-size: 0.9375rem;\n    letter-spacing: 0.025em;\n  }\n\n      \n  .modal {\n    display: none;\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.5);\n    z-index: var(--ai-z-modal);\n  }\n\n  .modal.open {\n    display: block;\n  }\n\n  .modal-content {\n    position: relative;\n    background: var(--ai-background);\n    width: 95%;\n    max-width: 1200px;\n    height: 85vh;\n    margin: 5vh auto;\n    padding: 1.5rem;\n    border-radius: var(--ai-radius-lg);\n    box-shadow: var(--ai-shadow-md);\n    display: flex;\n    flex-direction: column;\n    z-index: var(--ai-z-content);\n  }\n\n  .modal-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 1.5rem;\n  }\n\n  .modal-header h2 {\n    margin: 0;\n    font-size: 1.5rem;\n    font-weight: 600;\n    color: var(--ai-text);\n  }\n\n  .modal-body {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n    position: relative;\n  }\n\n  .editor-section {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n  }\n\n  .image-upload-section {\n    margin-bottom: 1rem;\n  }\n\n  .tools-container {\n    margin-bottom: 1rem;\n  }\n\n  .chat-section {\n    flex-shrink: 0;\n  }\n\n  .close-button {\n    position: absolute;\n    top: 1rem;\n    right: 1rem;\n    background: none;\n    border: none;\n    font-size: 1.5rem;\n    cursor: pointer;\n    color: var(--ai-text-light);\n    transition: color 0.2s ease;\n    z-index: 1;\n  }\n\n  .close-button:hover {\n    color: var(--ai-text);\n  }\n\n      ${r}\n      \n  .image-preview-card {\n    background: var(--ai-background);\n    border: 1px solid var(--ai-border);\n    border-radius: var(--ai-radius);\n    padding: 1rem;\n    margin-bottom: 1rem;\n    animation: fadeIn 0.3s ease forwards;\n  }\n\n  .image-preview-content {\n    display: flex;\n    align-items: flex-start;\n    gap: 1rem;\n  }\n\n  .image-preview-thumbnail {\n    width: 96px;\n    height: 96px;\n    position: relative;\n    border-radius: var(--ai-radius);\n    overflow: hidden;\n    background: var(--ai-background-light);\n  }\n\n  .image-preview-thumbnail img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n  }\n\n  .image-preview-info {\n    flex: 1;\n  }\n\n  .image-preview-label {\n    font-size: 0.875rem;\n    color: var(--ai-text-light);\n    margin-bottom: 0.25rem;\n  }\n\n  .image-preview-filename {\n    font-size: 0.875rem;\n    color: var(--ai-text);\n  }\n\n  .image-preview-remove {\n    padding: 0.25rem;\n    border: none;\n    background: none;\n    color: var(--ai-text-light);\n    cursor: pointer;\n    opacity: 0.7;\n    transition: all 0.2s ease;\n  }\n\n  .image-preview-remove:hover {\n    opacity: 1;\n    color: var(--ai-text);\n  }\n\n  /* Estilos para el botón de upload en el chat */\n  .chat-actions {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    margin-bottom: 1rem;\n  }\n\n  .chat-upload-button {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.375rem 0.75rem;\n    background: var(--ai-background-light);\n    border: 1px solid var(--ai-border);\n    border-radius: var(--ai-radius);\n    color: var(--ai-text);\n    font-size: 0.875rem;\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .chat-upload-button:hover {\n    background: var(--ai-secondary);\n    border-color: var(--ai-border);\n  }\n\n  .chat-upload-button svg {\n    width: 16px;\n    height: 16px;\n  }\n\n  /* Ocultar input de archivo */\n  .hidden {\n    display: none !important;\n  }\n\n      \n  .ai-notification {\n    position: fixed;\n    top: 1rem;\n    right: 1rem;\n    padding: 1rem;\n    border-radius: var(--ai-radius);\n    animation: slideIn 0.3s ease-out;\n    z-index: 1000;\n    max-width: 300px;\n    display: flex;\n    align-items: flex-start;\n    gap: 0.5rem;\n  }\n\n  .ai-notification.info {\n    background: var(--ai-info-bg, #e3f2fd);\n    color: var(--ai-info-text, #0d47a1);\n    border: 1px solid var(--ai-info-border, #90caf9);\n  }\n\n  .ai-notification.warning {\n    background: var(--ai-warning-bg);\n    color: var(--ai-warning-text);\n    border: 1px solid var(--ai-warning-border);\n  }\n\n  .ai-notification.error {\n    background: var(--ai-error-bg);\n    color: var(--ai-error-text);\n    border: 1px solid var(--ai-error-border);\n  }\n\n  .ai-notification.success {\n    background: var(--ai-success-bg, #e8f5e9);\n    color: var(--ai-success-text, #1b5e20);\n    border: 1px solid var(--ai-success-border, #a5d6a7);\n  }\n\n  .notification-close {\n    background: none;\n    border: none;\n    padding: 0;\n    cursor: pointer;\n    color: currentColor;\n    opacity: 0.7;\n  }\n\n  .notification-close:hover {\n    opacity: 1;\n  }\n\n  @keyframes slideIn {\n    from { transform: translateX(100%); opacity: 0; }\n    to { transform: translateX(0); opacity: 1; }\n  }\n\n  @keyframes slideOut {\n    from { transform: translateX(0); opacity: 1; }\n    to { transform: translateX(100%); opacity: 0; }\n  }\n\n      \n      /* Estilos específicos del componente */\n      :host {\n        display: inline-block;\n        font-family: var(--ai-font-sans);\n        position: relative;\n      }\n\n      .editor-section {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        min-height: 0;\n      }\n\n      .chat-section {\n        position: relative;\n        width: 100%;\n        bottom: 0;\n        left: 0;\n      }\n\n      .tools-container {\n        margin-bottom: 1rem;\n      }\n\n      response-history {\n        flex: 1;\n        min-height: 0;\n        max-height: calc(85vh - 120px);\n        background: var(--ai-background);\n        border-radius: var(--ai-radius);\n        margin-bottom: 1rem;\n        overflow: auto;\n        display: block;\n      }\n      \n      /* Contenedor de notificaciones */\n      .notifications-container {\n        position: fixed;\n        top: 1rem;\n        right: 1rem;\n        z-index: var(--ai-z-notification, 100001);\n        pointer-events: none;\n      }\n      \n      .notifications-container > * {\n        pointer-events: auto;\n      }\n      \n      /* Estilos de ayuda y depuración */\n      .debug-info {\n        display: none;\n        padding: 10px;\n        margin: 10px 0;\n        background: #f8f9fa;\n        border: 1px solid #dee2e6;\n        border-radius: 4px;\n        font-size: 12px;\n      }\n      \n      /* Mostrar en modo depuración */\n      :host([debug]) .debug-info {\n        display: block;\n      }\n    </style>\n\n    \x3c!-- Botón para abrir el modal --\x3e\n    <button class="modal-trigger" id="modal-trigger-button">\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n        <path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72"/>\n        <path d="m14 7 3 3"/>\n      </svg>\n      <span>${(null==n?void 0:n.modalTrigger)||"Enhance with AI"}</span>\n    </button>\n    \n    \x3c!-- Modal principal --\x3e\n    <div class="modal" id="ai-enhancer-modal">\n      <div class="modal-content">\n        <button class="close-button" aria-label="Close modal">×</button>\n        <div class="modal-header">\n          <h2>${(null==n?void 0:n.modalTitle)||"Enhance Text"}</h2>\n        </div>\n        \n        <div class="modal-body">\n          \x3c!-- Historial de respuestas --\x3e\n          <div class="editor-section">\n            <div class="tools-container">\n              <ai-toolbar \n                language="${e.language||"en"}" \n                has-content="${s.toString()}">\n              </ai-toolbar>\n            </div>\n            <response-history language="${e.language||"en"}"></response-history>\n          </div>\n          \n          \x3c!-- Sección de chat --\x3e\n          <div class="chat-section">\n            <chat-with-image\n              language="${e.language||"en"}"\n              image-url="${e.imageUrl||""}"\n              api-provider="${e.apiProvider||"openai"}"\n              has-content="${s.toString()}"\n              has-context="${l.toString()}">\n            </chat-with-image>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Contenedor de notificaciones --\x3e\n    <div class="notifications-container"></div>`}catch(n){return console.error("[createTemplate] Error creando template:",n),`\n    <div style="color: red; padding: 10px; border: 1px solid red;">\n      Error creating component template: ${n.message}\n    </div>\n    <button class="modal-trigger">Enhance Text</button>\n    <div class="modal">\n      <div class="modal-content">\n        <button class="close-button">×</button>\n        <div class="modal-header">\n          <h2>Enhance Text</h2>\n        </div>\n        <div class="modal-body">\n          <p>Error loading component. Please try refreshing the page.</p>\n        </div>\n      </div>\n    </div>`}}class E extends HTMLElement{constructor(){var e;super(),Object.assign(this,f,y,b,x),customElements.get("ai-toolbar")||customElements.define("ai-toolbar",s),customElements.get("chat-with-image")||customElements.define("chat-with-image",a),customElements.get("response-history")||customElements.define("response-history",i),this.eventEmitter=(e=this,{emit:(n,t)=>{const o=new CustomEvent(n,{detail:t,bubbles:!0,composed:!0});e.dispatchEvent(o)},on:(n,t)=>(e.addEventListener(n,t),()=>e.removeEventListener(n,t)),off:(n,t)=>{e.removeEventListener(n,t)}}),this.responseHistory=null,this.editorAdapter=null,this.currentAction="improve",this.modelManager=new d,this.markdownHandler=new p,this.tokenManager=new c,this.initializeStateManager(),this.cacheManager=function(e={}){return new u(e)}({prefix:"ai-text-enhancer",maxItems:20,ttl:18e5}),this.stateManager.batchUpdate({enhancedText:"",chatMessages:[],isInitialized:!1,productImage:null,usageControl:null}),this.bindMethods()}bindMethods(){var e,n,t,o,r,i,a,s,l;this.handleToolAction=null==(e=this.handleToolAction)?void 0:e.bind(this),this.handleChatMessage=null==(n=this.handleChatMessage)?void 0:n.bind(this),this.handleResponseCopy=null==(t=this.handleResponseCopy)?void 0:t.bind(this),this.handleResponseUse=null==(o=this.handleResponseUse)?void 0:o.bind(this),this.handleResponseRetry=null==(r=this.handleResponseRetry)?void 0:r.bind(this),this.handleResponseEdit=null==(i=this.handleResponseEdit)?void 0:i.bind(this),this.handleKeyboard=null==(a=this.handleKeyboard)?void 0:a.bind(this),this.handleModalKeyboard=null==(s=this.handleModalKeyboard)?void 0:s.bind(this),this.modalTriggerHandler=null==(l=this.modalTriggerHandler)?void 0:l.bind(this)}static get observedAttributes(){return["editor-id","api-key","api-provider","api-model","language","prompt","context","image-url","tenant-id","user-id","quota-endpoint","proxy-endpoint"]}get language(){return this.getAttribute("language")||"en"}get translations(){return e[this.language]||e.en}get editorId(){return this.getAttribute("editor-id")}get apiKey(){return this.getAttribute("api-key")}get prompt(){return this.getAttribute("prompt")||"You are a professional content enhancer. Improve the text while maintaining its core message and intent."}get currentContent(){var e;return(null==(e=this.editorAdapter)?void 0:e.getContent())||""}get apiProvider(){return this.getAttribute("api-provider")||"openai"}get apiModel(){var e;const n=this.getAttribute("api-model");try{return null==(e=this.modelManager.getModelConfig(n))?void 0:e.id}catch{return this.modelManager.getDefaultModel()}}get imageUrl(){return this.getAttribute("image-url")}get context(){return this.getAttribute("context")||""}get proxyEndpoint(){return this.getAttribute("proxy-endpoint")}async connectedCallback(){try{console.log("[AITextEnhancer] Component connected, initializing...");!function(e,n){if(!e)return console.error("Error: No se proporcionó un componente para attachShadowTemplate"),null;if(!n)return console.error("Error: No se proporcionó contenido de plantilla para attachShadowTemplate"),null;if(console.log("Attaching shadow template to component:",{componentTagName:e.tagName,templateContentLength:n.length}),e.shadowRoot)for(console.log("El componente ya tiene un shadowRoot, no se creará uno nuevo");e.shadowRoot.firstChild;)e.shadowRoot.removeChild(e.shadowRoot.firstChild);else try{e.attachShadow({mode:"open"}),console.log("Shadow root creado:",!!e.shadowRoot)}catch(t){return console.error("Error creando shadow root:",t),null}try{const t=document.createElement("template");t.innerHTML=n,console.log("Template element creado con contenido de longitud:",t.innerHTML.length);const o=t.content.cloneNode(!0);console.log("Contenido clonado:",{hasContent:!!o,childNodes:o.childNodes.length}),e.shadowRoot.appendChild(o),console.log("Contenido agregado al shadow root");const r={modalTrigger:e.shadowRoot.querySelector(".modal-trigger"),modal:e.shadowRoot.querySelector(".modal"),aiToolbar:e.shadowRoot.querySelector("ai-toolbar"),chatWithImage:e.shadowRoot.querySelector("chat-with-image"),responseHistory:e.shadowRoot.querySelector("response-history")};return console.log("Elementos renderizados:",{hasModalTrigger:!!r.modalTrigger,hasModal:!!r.modal,hasAiToolbar:!!r.aiToolbar,hasChatWithImage:!!r.chatWithImage,hasResponseHistory:!!r.responseHistory}),e.shadowRoot}catch(t){return console.error("Error procesando template:",t),null}}(this,w(this)),console.log("[AITextEnhancer] Shadow DOM created");const e=this.shadowRoot.querySelector(".notifications-container");e&&(this.notificationManager=new v(e),console.log("[AITextEnhancer] Notification manager initialized")),this.ensureModalExists(),this.updateLanguageForChildren(this.language),this.setupEventListeners(),function(e){document.addEventListener("keydown",e.handleKeyboard.bind(e));const n=e.shadowRoot.querySelector(".modal");n&&n.addEventListener("keydown",e.handleModalKeyboard.bind(e))}(this),await this.initializeComponents(),console.log("[AITextEnhancer] Components initialized"),this.setupEditorListener(),this.updateChatState(),setTimeout((()=>{console.log("[AITextEnhancer] Re-binding events after initialization"),this.bindEvents();const e=this.shadowRoot.querySelector(".modal-trigger");e?console.log("[AITextEnhancer] Modal trigger element:",e):console.warn("[AITextEnhancer] Modal trigger still not found after initialization")}),200),console.log("[AITextEnhancer] Component fully initialized")}catch(e){console.error("[AITextEnhancer] Error initializing component:",e);try{if(this.notificationManager)this.notificationManager.error(`Initialization error: ${e.message}`);else if(this.shadowRoot){const n=document.createElement("div");n.style.color="red",n.style.padding="10px",n.style.margin="10px 0",n.style.border="1px solid red",n.textContent=`Error initializing component: ${e.message}`,this.shadowRoot.appendChild(n)}}catch(n){console.error("[AITextEnhancer] Error showing notification:",n)}}}attributeChangedCallback(e,n,t){if(console.log("[AITextEnhancer] Attribute changed:",e,"from",n,"to",t),n!==t)switch(e){case"api-key":this.apiClient?this.apiClient.setApiKey(t):this.isInitialized||this.initializeComponents();break;case"language":this.updateLanguageForChildren(t);break;case"context":setTimeout((()=>this.updateChatState()),100);break;case"api-provider":case"api-model":case"proxy-endpoint":this.isInitialized&&this.apiClient&&this.apiClient.updateConfig({provider:this.apiProvider,model:this.apiModel,proxyEndpoint:this.proxyEndpoint});break;case"image-url":if(this.isInitialized){const e=this.shadowRoot.querySelector("chat-with-image");e&&e.setAttribute("image-url",t||"")}}}setupEditorListener(){if(!this.editorId)return void console.warn("[AITextEnhancer] No editor ID provided");const e=document.getElementById(this.editorId);if(!e)return console.warn(`[AITextEnhancer] Editor element with ID "${this.editorId}" not found`),void(this.notificationManager&&this.notificationManager.warning(`Editor element "${this.editorId}" not found. Text enhancement functionality may be limited.`));this._editorChangeListener&&(e.removeEventListener("input",this._editorChangeListener),e.removeEventListener("change",this._editorChangeListener)),this._editorChangeListener=()=>{this.isModalOpen()&&(this.updateChatState(),this.updateVisibleTools())},e.addEventListener("input",this._editorChangeListener),e.addEventListener("change",this._editorChangeListener),console.log(`[AITextEnhancer] Editor listener set up for "${this.editorId}"`)}updateLanguageForChildren(e){if(console.log("[AITextEnhancer] Updating language for children:",e),!this.shadowRoot)return void console.warn("[AITextEnhancer] No shadowRoot available yet");const n=this.shadowRoot.querySelector(".modal-trigger span"),t=this.shadowRoot.querySelector(".modal-header h2");if(n&&(n.textContent=this.translations.modalTrigger||"Enhance Text",console.log("[AITextEnhancer] Updated modal trigger text:",n.textContent)),t&&(t.textContent=this.translations.modalTitle||"Enhance Text",console.log("[AITextEnhancer] Updated modal title text:",t.textContent)),this.modalTriggerHandler){const e=this.shadowRoot.querySelector(".modal-trigger");e&&(e.removeEventListener("click",this.modalTriggerHandler),e.addEventListener("click",this.modalTriggerHandler))}const o=this.shadowRoot.querySelectorAll("[language]");console.log("[AITextEnhancer] Found components to update:",o.length),o.forEach((n=>{const t=n.getAttribute("language");n.setAttribute("language",e),console.log("[AITextEnhancer] Updated component language:",{component:n.tagName,from:t,to:e})}));[this.shadowRoot.querySelector("ai-toolbar"),this.shadowRoot.querySelector("chat-with-image"),this.shadowRoot.querySelector("response-history")].forEach((n=>{n&&(n.setAttribute("language",e),console.log("[AITextEnhancer] Forced language update on:",n.tagName))}))}modalTriggerHandler(){var e,n,t,o;if(console.log("[AITextEnhancer] Modal trigger clicked, checking shadowRoot"),!this.shadowRoot)return void console.error("[AITextEnhancer] Shadow root not available");const r=this.shadowRoot.querySelector(".modal");if(!r){if(console.error("[AITextEnhancer] Modal element not found in shadowRoot"),this.notificationManager&&this.notificationManager.warning("Modal not found, trying to recreate it..."),!this.ensureModalExists())return;{const e=this.shadowRoot.querySelector(".modal");if(!e)return void(this.notificationManager&&this.notificationManager.error("Failed to recreate modal"));r=e}}console.log("[AITextEnhancer] Opening modal with current state:",{apiProvider:this.apiProvider,model:this.apiModel,language:this.language,context:(null==(e=this.context)?void 0:e.substring(0,50))+((null==(n=this.context)?void 0:n.length)>50?"...":""),imageUrl:this.imageUrl,hasContent:Boolean(null==(t=this.currentContent)?void 0:t.trim()),hasContext:Boolean(null==(o=this.context)?void 0:o.trim())}),r.classList.add("open"),setTimeout((()=>{this.updateVisibleTools(),this.updateChatState();const e=r.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e&&e.focus()}),100)}ensureModalExists(){if(!this.shadowRoot)return console.error("[AITextEnhancer] No shadowRoot available for modal check"),!1;let e=this.shadowRoot.querySelector(".modal");if(!e){console.warn("[AITextEnhancer] Modal not found, attempting to recreate");const n=w(this),t=document.createRange().createContextualFragment(n).querySelector(".modal");if(!t)return console.error("[AITextEnhancer] Failed to recreate modal"),!1;{this.shadowRoot.appendChild(t),console.log("[AITextEnhancer] Modal recreated successfully");const n=t.querySelector(".close-button");n&&(n.onclick=()=>t.classList.remove("open")),t.onclick=e=>{e.target===t&&t.classList.remove("open")},e=t}}return!0}setupEventListeners(){const e=this.shadowRoot.querySelector("chat-with-image");e?(e.removeEventListener("chatMessage",this.handleChatMessage),e.addEventListener("chatMessage",this.handleChatMessage),console.log("[AITextEnhancer] Chat message event listener set up")):console.warn("[AITextEnhancer] Chat component not found"),this.responseHistory=this.shadowRoot.querySelector("response-history"),this.responseHistory?(this.markdownHandler&&(this.responseHistory.markdownHandler=this.markdownHandler),this.responseHistory.addEventListener("responseCopy",this.handleResponseCopy),this.responseHistory.addEventListener("responseUse",this.handleResponseUse),this.responseHistory.addEventListener("responseRetry",this.handleResponseRetry),this.responseHistory.addEventListener("responseEdit",this.handleResponseEdit),this.responseHistory.addEventListener("toolaction",this.handleToolAction),console.log("[AITextEnhancer] Response history events set up")):console.warn("[AITextEnhancer] Response history component not found"),this.addEventListener("configurationUpdated",(e=>{console.log("[AITextEnhancer] Configuration updated:",e.detail),this.isInitialized&&this.initializeComponents().catch((e=>{console.error("Error reinitializing components:",e),this.notificationManager&&this.notificationManager.error(`Failed to update configuration: ${e.message}`)}))})),this.bindEvents()}bindEvents(){if(!this.shadowRoot)return void console.error("[AITextEnhancer] No shadowRoot available in bindEvents");const e=this.shadowRoot.querySelector(".modal"),n=this.shadowRoot.querySelector(".modal-trigger");if(n?(this.modalTriggerHandler||(this.modalTriggerHandler=this.modalTriggerHandler.bind(this)),n.removeEventListener("click",this.modalTriggerHandler),n.addEventListener("click",this.modalTriggerHandler),console.log("[AITextEnhancer] Modal trigger event bound")):console.warn("[AITextEnhancer] Modal trigger not found in bindEvents"),e){e.onclick=n=>{n.target===e&&e.classList.remove("open")};const n=e.querySelector(".close-button");n?(n.onclick=()=>e.classList.remove("open"),console.log("[AITextEnhancer] Close button event bound")):console.warn("[AITextEnhancer] Close button not found in modal")}else console.warn("[AITextEnhancer] Modal element not found in bindEvents");const t=this.shadowRoot.querySelector("ai-toolbar");t?(t.removeEventListener("toolaction",this.handleToolAction),t.addEventListener("toolaction",this.handleToolAction),console.log("[AITextEnhancer] Toolbar events bound")):console.warn("[AITextEnhancer] Toolbar not found in bindEvents");const o=this.shadowRoot.querySelector("chat-with-image");o&&(o.removeEventListener("chatMessage",this.handleChatMessage),o.addEventListener("chatMessage",this.handleChatMessage),console.log("[AITextEnhancer] Chat component events bound")),this.responseHistory&&(this.responseHistory.removeEventListener("responseCopy",this.handleResponseCopy),this.responseHistory.removeEventListener("responseUse",this.handleResponseUse),this.responseHistory.removeEventListener("responseRetry",this.handleResponseRetry),this.responseHistory.removeEventListener("responseEdit",this.handleResponseEdit),this.responseHistory.removeEventListener("toolaction",this.handleToolAction),this.responseHistory.addEventListener("responseCopy",this.handleResponseCopy),this.responseHistory.addEventListener("responseUse",this.handleResponseUse),this.responseHistory.addEventListener("responseRetry",this.handleResponseRetry),this.responseHistory.addEventListener("responseEdit",this.handleResponseEdit),this.responseHistory.addEventListener("toolaction",this.handleToolAction),console.log("[AITextEnhancer] Response history events bound")),this.setupEditorListener(),console.log("[AITextEnhancer] All events bound successfully")}async initializeComponents(){if(this.isInitialized)console.log("[AITextEnhancer] Components already initialized, skipping");else try{console.log("[AITextEnhancer] Initializing components..."),await this.markdownHandler.initialize(),console.log("[AITextEnhancer] Markdown handler initialized");const e=this.proxyEndpoint||"http://llmproxy.test:8080/api/llm-proxy";this.apiClient=function(e={}){return new h(e)}({provider:this.apiProvider,model:this.apiModel,systemPrompt:this.prompt,temperature:.7,proxyEndpoint:e,tenantId:this.getAttribute("tenant-id")||"default",userId:this.getAttribute("user-id")||"default"}),console.log("[AITextEnhancer] API client initialized with provider",this.apiProvider),this.editorId?(this.editorAdapter=new g(this.editorId),console.log("[AITextEnhancer] Editor adapter initialized for",this.editorId)):console.warn("[AITextEnhancer] No editor ID provided, editor adapter not initialized");const n=this.shadowRoot.querySelector("response-history");return n&&(n.markdownHandler=this.markdownHandler,console.log("[AITextEnhancer] Markdown handler passed to response history")),this.isInitialized=!0,this.notificationManager&&this.notificationManager.success("AI Text Enhancer initialized successfully"),this.updateVisibleTools(),!0}catch(e){throw console.error("Error in initializeComponents:",e),this.notificationManager&&this.notificationManager.error(`Initialization error: ${e.message}`),this.addResponseToHistory("error",`Initialization error: ${e.message}`),e}}isModalOpen(){var e;const n=null==(e=this.shadowRoot)?void 0:e.querySelector(".modal");return!!n&&n.classList.contains("open")}updateVisibleTools(){var e,n;const t=Boolean(null==(e=this.currentContent)?void 0:e.trim()),o=null==(n=this.shadowRoot)?void 0:n.querySelector("ai-toolbar");o&&(o.setAttribute("has-content",t.toString()),console.log("[AITextEnhancer] Updated toolbar has-content:",t))}async handleChatMessage(e){const{message:n,image:t}=e.detail;try{if(!(null==n?void 0:n.trim())&&!t)throw new Error("Message cannot be empty");const e={id:Date.now(),action:"chat-question",content:`**${this.translations.chat.question}:** ${n}`,timestamp:new Date,image:t};this.responseHistory.addResponse(e);const o=Date.now()+1;this.responseHistory.addResponse({id:o,action:"chat-response",content:"",timestamp:new Date});const r=e=>{this.responseHistory.updateResponse(o,(n=>n+e))};await this.apiClient.chatResponse(this.currentContent,n.trim(),t,r),setTimeout((()=>{const e=this.shadowRoot.querySelector(".response-container");e&&(e.scrollTop=e.scrollHeight)}),200),this.notificationManager&&this.notificationManager.success("Response received",2e3)}catch(o){console.error("Chat Error:",o);const e=this.formatErrorMessage(o);this.addResponseToHistory("chat-error",e),this.notificationManager&&this.notificationManager.error(`Chat error: ${o.message}`)}}requestUpdate(e=null){return this.stateManager&&"function"==typeof this.stateManager.triggerUpdate?this.stateManager.triggerUpdate(e):(console.warn("[AITextEnhancer] StateManager or triggerUpdate method not available"),!1)}updateChatState(){var e,n,t,o;if(!this.shadowRoot)return;const r=this.shadowRoot.querySelector("chat-with-image");if(!r)return;const i=Boolean(null==(e=this.currentContent)?void 0:e.trim()),a=Boolean(null==(n=this.context)?void 0:n.trim());r.setAttribute("has-content",i.toString()),r.setAttribute("has-context",a.toString()),console.log("[AITextEnhancer] Updated chat state:",{hasContent:i,hasContext:a,contentLength:(null==(t=this.currentContent)?void 0:t.length)||0,contextLength:(null==(o=this.context)?void 0:o.length)||0})}async handleToolAction(e){const{action:n,responseId:t,content:o}=e.detail;console.log("[AITextEnhancer] Tool action received:",{action:n,responseId:t});let r=null;try{const e=o||this.currentContent,t=this.cacheManager.get(n,e);if(t)return console.log("[AITextEnhancer] Using cached response for",n),void this.addResponseToHistory(n,t);r={id:Date.now(),action:n,content:"",timestamp:new Date},this.responseHistory.addResponse(r),this.apiClient&&this.stateManager.get("isInitialized")||(console.log("[AITextEnhancer] Components not initialized, initializing now..."),await this.initializeComponents());const a=e=>{e&&this.responseHistory.updateResponse(r.id,(n=>n+e))};try{console.log("[AITextEnhancer] Making API request for action:",n);const t=await this.apiClient.enhanceText(e,n,null,this.context,a);this.cacheManager.set(n,e,t),this.updateChatState(),this.notificationManager&&this.notificationManager.success(`Text ${n}d successfully`,2e3)}catch(i){console.error("[AITextEnhancer] API request error:",i),r&&this.responseHistory.removeResponse(r.id),this.addResponseToHistory("error",this.formatErrorMessage(i)),this.notificationManager&&this.notificationManager.error(`Error: ${i.message}`)}}catch(i){console.error("[AITextEnhancer] Error in handleToolAction:",i),r&&this.responseHistory.removeResponse(r.id),this.addResponseToHistory("error",`Error: ${i.message}`),this.notificationManager&&this.notificationManager.error(`Error: ${i.message}`)}}}return customElements.define("ai-text-enhancer",E),E}));
//# sourceMappingURL=ai-text-enhancer.umd.js.map
